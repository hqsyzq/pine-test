
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        
        <title>é’æ¾è®°è´¦</title>
    
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="é’æ¾è®°è´¦">
        
        <meta name="theme-color" content="#f5f5f4">
        <meta name="theme-color" content="#fff1f2">
    
        <link rel="apple-touch-icon" href="./logo.png">
        <link rel="icon" type="image/png" href="./logo.png">
    
        <script>...</script>
        <script src="./js/tailwindcss.js"></script>
    
        <style>
            body { 
                /* ç¦æ­¢ç‚¹å‡»é«˜äº® (å»é™¤ç‚¹å‡»æ—¶çš„ç°è‰²èƒŒæ™¯) */
                -webkit-tap-highlight-color: transparent; 
                background-color: #fff1f2; 
                /* ç¦æ­¢ä¸‹æ‹‰åˆ·æ–°/æ©¡çš®ç­‹æ•ˆæœ */
                overscroll-behavior: none; 
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                
                /* --- æ–°å¢ä¼˜åŒ– --- */
                /* ç¦æ­¢ç”¨æˆ·é€‰ä¸­æ–‡å­— (åƒåŸç”ŸAppä¸€æ ·) */
                -webkit-user-select: none;
                user-select: none;
                /* ç¦æ­¢ç§»åŠ¨ç«¯åŒå‡»ç¼©æ”¾ */
                touch-action: manipulation;
                /* é€‚é…åˆ˜æµ·å±çš„å®‰å…¨è·ç¦» */
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            /* å…è®¸è¾“å…¥æ¡†å†…çš„æ–‡å­—è¢«é€‰ä¸­å’Œç¼–è¾‘ */
            input, textarea {
                -webkit-user-select: text;
                user-select: text;
            }
    
            .no-scrollbar::-webkit-scrollbar { display: none; }
            .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
            @keyframes fade-in { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
            .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
            @keyframes slide-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .animate-slide-up { animation: slide-up 0.2s ease-out forwards; }
            
			@keyframes explodeMove {
			    0% { 
			        opacity: 0; 
			        transform: translate(-50%, -50%) scale(0.5); 
			    }
			    20% { 
			        opacity: 1; 
			        transform: translate(-50%, -50%) scale(1); 
			    }
			    100% { 
			        opacity: 0; 
			        /* var(--tx) å’Œ var(--ty) æ˜¯æˆ‘ä»¬åé¢ç”¨ JS éšæœºç”Ÿæˆçš„é£è¡Œæ–¹å‘ */
			        transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0.5) rotate(var(--r)); 
			    }
			}
			.animate-explode {
			    position: fixed;
			    left: 50%;
			    top: 50%;
			    animation: explodeMove 1s ease-out forwards;
			    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ï¼Œä¸å½±å“æ“ä½œ */
			    z-index: 9999;
			}
			
            /* é’ˆå¯¹ iOS åº•éƒ¨å®‰å…¨åŒºçš„é€‚é… */
            .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
            
            /* åŠ è½½æ—¶çš„æ ·å¼ */
            #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; background: #f5f5f4; z-index: 9999; color: #57534e; font-weight: bold; transition: opacity 0.5s; }
            #debug-info { display: none; position: fixed; top: 0; left: 0; right: 0; background: rgba(239, 68, 68, 0.9); color: white; padding: 20px; font-size: 12px; z-index: 10000; word-break: break-all; }
        </style>
    
    <!-- 1. æ·»åŠ é”™è¯¯æ•æ‰è„šæœ¬ï¼Œæ–¹ä¾¿æ‰‹æœºç«¯è°ƒè¯• -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            var errorMsg = "é”™è¯¯: " + message + "\nä½ç½®: " + source + ":" + lineno + ":" + colno;
            document.getElementById('debug-info').innerText = errorMsg;
            document.getElementById('debug-info').style.display = 'block';
        };
    </script>

    <!-- 2. æ›´æ¢ä¸ºå›½å†…ç¨³å®šçš„ CDN æº (Staticfile) -->
    <!-- Tailwind CSS (æ³¨æ„ï¼šå®é™…ç”Ÿäº§ç¯å¢ƒå»ºè®®æœ¬åœ°æ‰“åŒ…CSSï¼Œè¿™é‡Œä¸ºäº†å•æ–‡ä»¶è¿è¡Œä»ä½¿ç”¨CDNï¼Œä½†éœ€ç¡®ä¿æ‰‹æœºæœ‰ç½‘) -->
    <script src="./js/tailwindcss.js"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="./js/react.production.min.js"></script>
    <script crossorigin src="./js/react-dom.production.min.js"></script>
    
    <!-- Babel (ç”¨äºè§£æ JSX) -->
    <script src="./js/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f5f5f4; overscroll-behavior: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fade-in { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        @keyframes slide-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.2s ease-out forwards; }
        /* é’ˆå¯¹ iOS åº•éƒ¨å®‰å…¨åŒºçš„é€‚é… */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* åŠ è½½æ—¶çš„æ ·å¼ */
        #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; background: #f5f5f4; z-index: 9999; color: #57534e; font-weight: bold; transition: opacity 0.5s; }
        #debug-info { display: none; position: fixed; top: 0; left: 0; right: 0; background: rgba(239, 68, 68, 0.9); color: white; padding: 20px; font-size: 12px; z-index: 10000; word-break: break-all; }
    </style>
</head>
<body>
    <!-- è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="debug-info"></div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    ">
        <img src="./logo.png" style="width: 80px; height: 80px; margin-bottom: 20px; border-radius: 15px;">
        
        <div style="color: #333; font-size: 14px; font-weight: bold;">å®ï¼Œæ­£åœ¨ä¸ºä½ åŠ é€Ÿå¯åŠ¨...</div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // ç§»é™¤åŠ è½½åŠ¨ç”»
        setTimeout(() => {
            const loading = document.getElementById('loading');
            if(loading) {
                loading.style.opacity = '0';
                setTimeout(() => loading.remove(), 500);
            }
        }, 500);

        const { useState, useEffect, useMemo, useRef } = React;

        // --- å½©è›‹å·¥å…·ï¼šä¸‹çˆ±å¿ƒé›¨ ---
        const triggerHeartRain = () => {
            const container = document.body;
            const hearts = ['â¤ï¸', 'ğŸ’–', 'ğŸŒ¸', 'ğŸ˜˜', 'âœ¨', 'ğŸ¬'];
            for (let i = 0; i < 30; i++) {
                const el = document.createElement('div');
                el.innerText = hearts[Math.floor(Math.random() * hearts.length)];
                el.style.position = 'fixed';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.top = '-50px';
                el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                el.style.zIndex = '9999';
                el.style.pointerEvents = 'none';
                el.style.transition = `transform ${Math.random() * 2 + 2}s linear, opacity 2s ease-in`;
                container.appendChild(el);
        
                // è§¦å‘åŠ¨ç”»
                requestAnimationFrame(() => {
                    el.style.transform = `translateY(${window.innerHeight + 100}px) rotate(${Math.random() * 360}deg)`;
                    el.style.opacity = '0';
                });
        
                // åŠ¨ç”»ç»“æŸåæ¸…ç†
                setTimeout(() => { container.removeChild(el); }, 4000);
            }
        };

        // --- å›¾æ ‡ç»„ä»¶ ---
        const Icon = ({ name, size = 20, className = "", strokeWidth = 2 }) => {
            // ç‰¹æ®Šå¤„ç†å…¬ç›Šå›¾æ ‡ - æ¢å¤ä¹‹å‰çš„ç‰ˆæœ¬
            if (name === 'handHeart') {
                return (
                    <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        width={size} 
                        height={size} 
                        viewBox="0 0 1029 1024" 
                        fill="currentColor" 
                        className={className}
                    >
                        <path d="M535.139297 1023.991c-26.876764 0-55.086516-7.307936-86.164243-22.334804-22.265804-10.791905-96.74915-49.314567-141.214759-72.332364l-40.264646-20.797817c-13.147884-6.727941-21.822808-9.767914-28.139753-9.767914-5.874948 0-11.611898 2.492978-24.521784 10.655906l-68.849395 44.703607a16.825852 16.825852 0 0 1-9.219919 2.731976c-1.604986 0-3.209972-0.238998-4.780958-0.682994-4.746958-1.399988-8.639924-4.780958-10.654906-9.289918L1.832984 681.660009c-3.789967-8.469926-0.101999-18.407838 8.299927-22.300804l13.864878-6.419944c1.09199-0.512995 115.498985-53.754528 169.014515-74.826342 28.959745-11.4059 54.880518-16.938851 79.299303-16.938851 46.991587 0 79.709299 20.627819 111.367021 40.571643l6.727941 4.234963c17.655845 11.030903 66.184418 46.138594 86.197242 60.686467l0.136999 0.102999c6.761941 3.653968 22.7788 11.884896 43.474618 19.26083 3.721967-2.355979 8.434926-5.361953 13.044885-8.298927l5.429952-3.448969c19.227831-12.225893 23.974789-15.128867 25.682775-16.119859 13.864878-7.819931 33.365707-19.533828 57.95449-34.765694 28.41375-17.587845 61.676458-35.550688 93.232181-35.550688 18.509837 0 35.005692 5.770949 50.169559 17.621845 19.669827-11.133902 42.756624-16.939851 67.652405-16.939851 24.793782 0 46.958587 9.904913 60.857465 27.184761 0.819993 1.058991 1.639986 2.117981 2.390979 3.209972 17.655845-6.726941 34.287699-10.107911 49.553565-10.107911 27.729756 0 51.875544 11.508899 67.995402 32.409715 12.361891 16.118858 17.416847 34.252699 14.615872 52.558538-3.892966 25.783773-22.231805 49.553564-57.749493 74.689344-27.491758 19.36283-286.836479 191.041321-323.310158 212.044136-5.087955 2.936974-10.346909 6.215945-15.264866 9.322918C608.324653 1005.071166 578.169918 1023.991 535.139297 1023.991zM239.149898 833.904671c17.10985 0 35.551688 5.395953 58.05749 17.00785l42.723624 22.061806c49.143568 25.408777 116.454976 60.174471 137.321793 70.283383 22.402803 10.893904 41.356637 16.152858 57.920491 16.152858 23.87179 0 41.117639-10.825905 62.974447-24.519785 5.054956-3.175972 11.269901-7.103938 17.451846-10.655906C651.014278 903.813056 906.602032 734.593544 933.820793 715.434712c28.652748-20.354821 30.940728-30.76973 31.043727-31.487723-0.102999-0.375997-0.579995-1.536986-1.946983-3.312971-2.32198-3.004974-6.624942-6.999938-17.04185-6.999939-9.561916 0-26.773765 3.41397-54.402522 19.669828l-30.70173 18.13484a16.922851 16.922851 0 0 1-8.605925 2.355979 17.06385 17.06385 0 0 1-9.937912-3.209971c-5.464952-3.960965-8.025929-10.791905-6.557943-17.382848l7.752932-34.833693c0.272998-1.195989 0.272998-1.980983 0.238998-2.32298-1.024991-1.023991-4.473961-2.799975-10.21091-2.799975-20.354821 0-35.995684 5.839949-47.84658 17.826843l-12.53289 12.737888a16.957851 16.957851 0 0 1-12.055894 5.054956c-0.340997 0-0.716994 0-1.05899-0.034a16.906851 16.906851 0 0 1-12.396891-6.625942l-10.825905-14.239875c-9.766914-12.909887-15.401865-15.436864-21.787809-15.436864-11.440899 0-29.984736 8.195928-58.364487 25.817773a2501.013018 2501.013018 0 0 1-35.790685 21.822808c30.462732 1.672985 52.661537 5.941948 69.907385 13.352883 30.838729 13.216884 46.479591 36.917676 46.479592 70.419381 0 22.403803-12.054894 41.529635-33.911702 53.789527-20.49082 11.473899-44.738607 14.889869-61.506459 15.742862-0.272998 0-0.545995 0.034-0.853993 0.033999l-159.486598 0.035c-57.98849 0-133.428827-30.053736-141.863753-33.468706a16.989851 16.989851 0 0 1-9.220919-9.11792c-1.741985-4.166963-1.775984-8.810923-0.068-12.977885l11.747897-28.652749a16.916851 16.916851 0 0 1 9.288918-9.254918c2.049982-0.819993 4.199963-1.229989 6.351945-1.229989 2.21998 0 4.473961 0.443996 6.556942 1.331988 1.604986 0.649994 70.829377 28.584749 117.17297 28.584749h158.15461c13.079885-0.750993 27.594757-4.678959 32.750712-7.922931-0.135999-3.687968-0.749993-4.405961-4.097964-6.317944-8.161928-4.712959-28.652748-10.313909-79.777299-10.31391-70.727378 0-138.688781-38.317663-146.201715-42.689624-0.340997-0.203998-0.716994-0.442996-1.05799-0.647995-0.477996-0.341997-1.399988-0.989991-6.249945-4.50796-15.675862-11.3379-63.384443-45.865597-78.957306-55.598511l-6.82994-4.302963c-28.311751-17.792844-48.734572-30.599731-77.114323-30.599731-15.91386 0-34.014701 4.063964-55.256514 12.430891-36.507679 14.446873-104.025086 45.079604-136.399801 59.935473l77.079322 171.098496s22.334804-14.479873 22.368804-14.514872c17.211849-10.825905 36.268681-20.899816 59.354478-20.899816z" />
                        <path d="M516.56046 641.838359c-18.372839 0-35.755686-8.059929-47.709581-22.129806-31.930719-37.907667-74.859342-73.083358-116.352977-107.099058l-0.135999-0.101999c-47.436583-38.829659-96.477152-79.025305-133.668825-125.778895-43.029622-54.129524-63.930438-109.933034-63.930438-170.6195 0-61.233462 21.549811-116.488976 60.686466-155.558633C254.620762 21.514811 309.947276 0 371.316736 0c48.801571 0 99.072129 21.822808 146.098716 63.282444C564.545038 21.822808 614.882596 0 663.718167 0c61.336461 0 116.694974 21.514811 155.79863 60.549468 39.136656 39.069657 60.686467 94.292171 60.686467 155.559633 0 60.686467-20.899816 116.488976-63.862439 170.551501-37.088674 46.68459-85.856245 86.607239-133.018831 125.232899l-0.785993 0.647994c-41.459636 34.014701-84.353259 69.156392-116.523976 107.167058-11.816896 14.035877-29.199743 22.163805-47.675581 22.163806h-1.775984zM371.316736 64.784431c-89.305215 0-151.699667 62.224453-151.699666 151.29067 0 103.888087 88.007226 175.981453 173.112478 245.649841 43.815615 35.926684 89.100217 73.015358 124.719904 114.986989 36.234682-42.483627 81.246286-79.333303 124.822903-114.952989C727.410607 392.056554 815.418833 319.997188 815.418833 216.075101 815.382834 127.008884 753.023382 64.784431 663.718167 64.784431c-52.148542 0-99.379127 41.220638-122.87592 65.775422l-11.166902 11.679897a16.922851 16.922851 0 0 1-12.226893 5.224954c-4.609959 0-9.015921-1.877983-12.225892-5.224954l-11.201902-11.679897c-23.529793-24.554784-70.726378-65.775422-122.704922-65.775422z" />
                    </svg>
                );
            }

            // ç‰¹æ®Šå¤„ç†é£æœºå›¾æ ‡ - æ¢å¤ä¹‹å‰çš„ç‰ˆæœ¬
            if (name === 'plane') {
                return (
                    <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        width={size} 
                        height={size} 
                        viewBox="0 0 1024 1024" 
                        fill="currentColor" 
                        className={className}
                    >
                        <path d="M714.94656 957.18912a20.21888 20.21888 0 0 1-19.33312-14.27968l-114.24256-371.76832-136.41216 115.58912 1.65376 201.04192a20.21888 20.21888 0 0 1-5.79584 14.336l-33.77152 34.37568a20.21376 20.21376 0 0 1-33.28-6.87616L300.672 740.6592l-196.17792-84.27008a20.22912 20.22912 0 0 1-6.5024-32.6912l33.6384-34.49344a20.25472 20.25472 0 0 1 15.46752-6.08256l205.76768 10.07616 115.89632-142.19264-374.35904-118.90176a20.21376 20.21376 0 0 1-8.33024-33.41824l64.26112-65.63328a20.2752 20.2752 0 0 1 16.47616-5.97504l461.64992 46.47936 130.82112-131.1232c52.10112-52.71552 102.05184-60.98944 127.18592-60.98944h0.36864c23.34208 0 43.96544 6.90176 55.23968 18.18112 27.22304 27.22304 25.87648 104.88832-47.46752 179.71712-0.05632 0.0512-0.10752 0.1536-0.1536 0.2048l-131.97312 131.75808 36.92544 458.3936a20.23936 20.23936 0 0 1-5.7088 15.78496l-64.3072 65.62816a20.22912 20.22912 0 0 1-14.44352 6.07744z m-123.24352-441.5232a20.21888 20.21888 0 0 1 19.31776 14.27968l113.25952 368.5888 34.06336-34.75968L721.408 405.248a20.20352 20.20352 0 0 1 5.86752-15.93344l138.52672-138.27072c33.99168-34.70336 45.952-65.15712 50.00704-84.59264 4.99712-23.9616-0.67584-36.28032-2.34496-38.05184-7.43936-7.33184-63.90784-19.62496-125.48096 42.71104a1.3568 1.3568 0 0 1-0.08704 0.08192l-137.61536 137.73824a20.21376 20.21376 0 0 1-16.32768 5.82656L172.43136 268.288l-34.47296 35.21024 371.38432 117.9392a20.21376 20.21376 0 0 1 9.55392 32.04608l-141.13792 173.16352c-4.06016 4.98688-10.24 7.72608-16.6656 7.424l-206.86848-10.12736-6.72256 6.89152 176.94208 76.0064a20.23936 20.23936 0 0 1 10.88 11.28448l64.84992 167.64928 5.93408-6.04672-1.65888-202.1376a20.18816 20.18816 0 0 1 7.14752-15.5904l167.03488-141.54752a20.23936 20.23936 0 0 1 13.07136-4.7872z" />
                    </svg>
                );
            }

            const paths = {
                // åŸºç¡€ UI å›¾æ ‡
                plus: <path d="M5 12h14M12 5v14"/>,
                home: <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>,
                pieChart: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z"/>,
                
                // é’±åŒ…ï¼šåœ†æ¶¦ç°ä»£é£æ ¼
                wallet: <><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-3"/></>,
                
                trendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18M17 6h6v6"/>,
                trendingDown: <polyline points="23 18 13.5 8.5 8.5 13.5 1 6M17 18h6v-6"/>,
                trash2: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/>,
                chevronLeft: <path d="m15 18-6-6 6-6"/>,
                chevronDown: <path d="m6 9 6 6 6-6"/>,
                save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                check: <path d="M20 6 9 17l-5-5"/>,
                x: <path d="M18 6 6 18M6 6l12 12"/>,
                edit2: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>,
                gripHorizontal: <path d="M12 9h.01M19 9h.01M5 9h.01M12 15h.01M19 15h.01M5 15h.01"/>,
                leaf: <><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></>,
                settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
                filter: <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>,
                book: <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>,
                fileText: <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></>,
                info: <><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></>,
                list: <><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>,
                shieldCheck: <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></>,
                zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
                
                // åˆ†ç±»å›¾æ ‡
                utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>, 
                coffee: <><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></>,
                shopping: <><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></>,
                transport: <><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></>,
                housing: <><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                game: <><line x1="6" x2="10" y1="12" y2="12"/><line x1="8" x2="8" y1="10" y2="14"/><line x1="15" x2="15.01" y1="13" y2="13"/><line x1="18" x2="18.01" y1="11" y2="11"/><rect width="20" height="12" x="2" y="6" rx="2"/></>,
                ticket: <><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v14"/><path d="M9 9h.01"/><path d="M9 15h.01"/><path d="M17 9h.01"/><path d="M17 15h.01"/></>, 
                medical: <><path d="M8 8v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M12 11v6"/><path d="M9 14h6"/></>, 
                education: <><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></>,
                gift: <><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></>,
                more: <><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></>,
                card: <><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></>,
                message: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>,
                scan: <><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></>, 
                globe: <><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></>, 
                chartLine: <><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></>, 
                clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                briefcase: <><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>, 
                cash: <><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></>,
                phone: <><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><path d="M12 18h.01"/></>,
                work: <><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>,
                heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
                scissors: <><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></>,
                
                // å® ç‰©ï¼šéª¨å¤´ç®€ç¬”
                bone: <path d="M17 10c.7-.7 1.69 0 2.5 0a2.5 2.5 0 1 0 0-5 .5.5 0 0 1-.5-.5 2.5 2.5 0 1 0-5 0c0 .81.7 1.8 0 2.5l-7 7c-.7.7-1.69 0-2.5 0a2.5 2.5 0 0 0 0 5c.28 0 .5.22.5.5a2.5 2.5 0 1 0 5 0c0-.81-.7-1.8 0-2.5Z"/>,

                // æ—…æ¸¸ï¼šå ä½ï¼Œä¸Šé¢å·²ç‰¹æ®Šå¤„ç†ï¼Œä½†è¿™é‡Œç•™ä¸€ä¸ªkeyé˜²æ­¢æŠ¥é”™
                plane: <circle cx="12" cy="12" r="10"/>,
                
                // å…¬ç›Šï¼šå ä½ï¼Œä¸Šé¢å·²ç‰¹æ®Šå¤„ç†ï¼Œä½†è¿™é‡Œç•™ä¸€ä¸ªkeyé˜²æ­¢æŠ¥é”™
                handHeart: <circle cx="12" cy="12" r="10"/>,

                // å‰¯ä¸šï¼šç¬”è®°æœ¬ç”µè„‘ (Laptop)
                laptop: <><rect x="3" y="4" width="18" height="12" rx="2" /><line x1="2" x2="22" y1="20" y2="20" /></>,

                // æ„å¤–æ‰€å¾—ï¼šä¿®å¤åçš„å®Œæ•´é—ªå…‰ (å¤§æ˜Ÿæ˜Ÿ + å³ä¸‹è§’å°æ˜Ÿæ˜Ÿ)
                sparkles: (
                    <>
                        {/* ä¸»æ˜Ÿæ˜Ÿï¼šä¿®å¤äº†å³ä¾§ç¼ºå¤±çš„å°–è§’ï¼Œç°åœ¨æ˜¯å®Œç¾çš„å››è§’æ˜Ÿ */}
                        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                        
                        {/* å³ä¸‹è§’å°æ˜Ÿæ˜Ÿï¼šæ›¿ä»£åŸæ¥çš„åŠ å·ï¼Œå¢åŠ é—ªçƒæ„Ÿ */}
                        <path d="M20 16l-0.5 1.5L18 18l1.5 0.5L20 20l0.5-1.5L22 18l-1.5-0.5Z" />
                    </>
                ),

                // æ¨±èŠ±
                sakura: (
                    <>
                        <path d="M12 2C9 2 7 5 7 7c0 2 2 4.5 5 5 3-.5 5-3 5-5 0-2-2-5-5-5z" />
                        <path d="M12 22c3 0 5-3 5-5 0-2-2-4.5-5-5-3 .5-5 3-5 5 0 2 2 5 5 5z" />
                        <path d="M2 12c0 3 3 5 5 5 2 0 4.5-2 5-5-.5-3-3-5-5-5-2 0-5 2-5 5z" />
                        <path d="M22 12c0-3-3-5-5-5-2 0-4.5 2-5 5 .5 3 3 5 5 5 2 0 5-2 5-5z" />
                        <circle cx="12" cy="12" r="2" />
                    </>
                ),
				
				twoHearts: (
				    <>
				        {/* åé¢çš„çˆ±å¿ƒ (ç¨å¾®æ·¡ä¸€ç‚¹ï¼Œåå·¦ä¸Š) */}
				        <path d="M8 4c-2.2 0-4 1.8-4 4 0 2.2 2 4.2 5 6.5l1 0.8 1-0.8c3-2.3 5-4.3 5-6.5 0-2.2-1.8-4-4-4-1.1 0-2.2 0.5-3 1.5C10.2 4.5 9.1 4 8 4z" transform="translate(-2, -1) scale(0.9)" opacity="0.6" fill="currentColor" />
				        {/* å‰é¢çš„çˆ±å¿ƒ (ä¸»è§†è§‰ï¼Œåå³ä¸‹) */}
				        <path d="M15 9c-2.2 0-4 1.8-4 4 0 2.2 2 4.2 5 6.5l1 0.8 1-0.8c3-2.3 5-4.3 5-6.5 0-2.2-1.8-4-4-4-1.1 0-2.2 0.5-3 1.5C17.2 9.5 16.1 9 15 9z" fill="currentColor" />
				    </>
				),
				
                // æ¾æ ‘
                tree: <><path d="M12 2L7 8H10L6 13H9L5 19H19L15 13H18L14 8H17L12 2Z" /><path d="M12 19V22" /></>,
                
				// æ–°å¢ï¼šä¹¦ç­¾å›¾æ ‡ (ç”¨äºæ¨¡æ¿)
				bookmark: <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />,
				
                // å«ç”Ÿå·¾ (æ ¹æ®å›¾ç‰‡å®šåˆ¶ï¼šèŠ±ç”Ÿå½¢è½®å»“ + æŠ¤ç¿¼ + ä¸­é—´èƒ¶å›ŠèŠ¯)
                sanitary: (
                    <>
                        {/* å¤–è½®å»“ï¼šåŒ…å«æŠ¤ç¿¼çš„æ•´ä½“å½¢çŠ¶ */}
                        <path d="M12 2C14.5 2 16.5 3.5 16.5 6V8.5C16.5 8.8 16.8 9 17.1 9H18C19.1 9 20 9.9 20 11V13C20 14.1 19.1 15 18 15H17.1C16.8 15 16.5 15.2 16.5 15.5V18C16.5 20.5 14.5 22 12 22C9.5 22 7.5 20.5 7.5 18V15.5C7.5 15.2 7.2 15 6.9 15H6C4.9 15 4 14.1 4 13V11C4 9.9 4.9 9 6 9H6.9C7.2 9 7.5 8.8 7.5 8.5V6C7.5 3.5 9.5 2 12 2Z" />
                        {/* ä¸­é—´èŠ¯ä½“ï¼šèƒ¶å›ŠçŠ¶ */}
                        <rect x="10.5" y="9" width="3" height="6" rx="1.5" />
                    </>
                ),
                coins: <><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/><path d="m14 11-2.8 2.8"/></>,
                store: <><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></>,
                transfer: <><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></>,
                bank: <><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/></>,
                debt: <><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></>,
                loan: <><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></>,
                truck: <><path d="M10 17h4V5H2v12h3"/><path d="M20 17h2v-3.34a4 4 0 0 0-1.17-2.83L19 9h-5"/><path d="M14 17h1"/><circle cx="7.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></>,
                hammer: <><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V2.75A.75.75 0 0 0 18 2h-2.25c-.85 0-1.65.33-2.25.93L12.25 4.18"/><path d="M8 8l-4 4"/></>,
                arrowRight: <path d="M5 12h14M12 5l7 7-7 7"/>
            };
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth={strokeWidth}
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {paths[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        const ICON_KEYS = ['utensils','coffee','shopping','transport','housing','game','ticket','medical','education','gift','more','wallet','card','cash','message','phone','scan','work','leaf','home','trendingUp','trendingDown','heart','scissors','bone','plane','charity','handHeart','coins','zap','store','sparkles','transfer','bank','debt','loan','globe','chartLine','clock','briefcase','laptop','book','info','truck','hammer', 'tree','sanitary','sakura', 'twoHearts'];

        const DEFAULT_CATEGORIES = {
            expense: [
                { id: 'food', name: 'é¤é¥®', iconKey: 'utensils', color: 'bg-orange-100 text-orange-700' },
                { id: 'shopping', name: 'è´­ç‰©', iconKey: 'shopping', color: 'bg-pink-100 text-pink-700' },
                { id: 'transport', name: 'äº¤é€š', iconKey: 'transport', color: 'bg-blue-100 text-blue-700' },
                { id: 'housing', name: 'å±…ä½', iconKey: 'housing', color: 'bg-indigo-100 text-indigo-700' },
                { id: 'love', name: 'æ‹çˆ±', iconKey: 'heart', color: 'bg-rose-100 text-rose-700' },
                { id: 'haircut', name: 'ç†å‘', iconKey: 'scissors', color: 'bg-pink-100 text-pink-700' },
                { id: 'phone_bill', name: 'è¯è´¹', iconKey: 'phone', color: 'bg-green-100 text-green-700' },
                { id: 'entertainment', name: 'å¨±ä¹', iconKey: 'game', color: 'bg-purple-100 text-purple-700' },
                { id: 'pet', name: 'å® ç‰©', iconKey: 'bone', color: 'bg-amber-100 text-amber-700' },
                { id: 'invest_exp', name: 'é‡‘èæŠ•èµ„', iconKey: 'trendingUp', color: 'bg-red-100 text-red-700' },
                { id: 'self_growth', name: 'è‡ªèº«æŠ•èµ„', iconKey: 'education', color: 'bg-sky-100 text-sky-700' },
                { id: 'travel', name: 'æ—…æ¸¸', iconKey: 'plane', color: 'bg-cyan-100 text-cyan-700' },
                { id: 'social', name: 'äººæƒ…', iconKey: 'gift', color: 'bg-red-50 text-red-600' },
                { id: 'charity', name: 'å…¬ç›Š', iconKey: 'handHeart', color: 'bg-emerald-50 text-emerald-600' },
                { id: 'medical', name: 'åŒ»ç–—', iconKey: 'medical', color: 'bg-red-100 text-red-700' },
				{ id: 'hygiene', name: 'å«ç”Ÿ', iconKey: 'sanitary', color: 'bg-rose-100 text-rose-700' },
                { id: 'other', name: 'å…¶å®ƒ', iconKey: 'more', color: 'bg-gray-100 text-gray-700' },
            ],
            income: [
                { id: 'salary', name: 'å·¥èµ„', iconKey: 'work', color: 'bg-emerald-100 text-emerald-700' },
                { id: 'part_time', name: 'å…¼èŒ', iconKey: 'clock', color: 'bg-blue-100 text-blue-700' },
                { id: 'side_job', name: 'å‰¯ä¸š', iconKey: 'laptop', color: 'bg-yellow-100 text-yellow-700' },
                { id: 'business', name: 'ç»è¥æ‰€å¾—', iconKey: 'store', color: 'bg-indigo-100 text-indigo-700' },
                { id: 'invest_inc', name: 'æŠ•èµ„æ”¶å…¥', iconKey: 'trendingUp', color: 'bg-red-100 text-red-700' },
                { id: 'bonus', name: 'å¥–é‡‘', iconKey: 'gift', color: 'bg-orange-100 text-orange-700' },
                { id: 'social_inc', name: 'äººæƒ…æ”¶å…¥', iconKey: 'heart', color: 'bg-rose-100 text-rose-700' },
                { id: 'windfall', name: 'æ„å¤–æ‰€å¾—', iconKey: 'sparkles', color: 'bg-purple-100 text-purple-700' },
                { id: 'other_inc', name: 'å…¶å®ƒæ”¶å…¥', iconKey: 'more', color: 'bg-gray-100 text-gray-700' },
            ]
        };

        const DEFAULT_ACCOUNTS = [
            { id: 'wechat', name: 'å¾®ä¿¡é›¶é’±', group: 'asset', isLiquid: true, initialBalance: 0, iconKey: 'message', color: 'bg-green-600' },
            { id: 'alipay', name: 'æ”¯ä»˜å®', group: 'asset', isLiquid: true, initialBalance: 0, iconKey: 'scan', color: 'bg-blue-500' },
            { id: 'bank', name: 'é“¶è¡Œå¡', group: 'asset', isLiquid: true, initialBalance: 0, iconKey: 'card', color: 'bg-indigo-600' },
            { id: 'fund', name: 'åŸºé‡‘', group: 'asset', isLiquid: false, initialBalance: 0, iconKey: 'pieChart', color: 'bg-red-500' },
            { id: 'stock', name: 'è‚¡ç¥¨', group: 'asset', isLiquid: false, initialBalance: 0, iconKey: 'chartLine', color: 'bg-red-600' },
            { id: 'other_asset', name: 'å…¶å®ƒè´¦æˆ·', group: 'asset', isLiquid: false, initialBalance: 0, iconKey: 'wallet', color: 'bg-stone-500' },
            { id: 'payable', name: 'åº”ä»˜æ¬¾é¡¹', group: 'liability', initialBalance: 0, iconKey: 'debt', color: 'bg-orange-500' },
            { id: 'web_loan', name: 'ç½‘ç»œè´·æ¬¾', group: 'liability', initialBalance: 0, iconKey: 'globe', color: 'bg-purple-500' },
            { id: 'bank_loan', name: 'é“¶è¡Œè´·æ¬¾', group: 'liability', initialBalance: 0, iconKey: 'bank', color: 'bg-blue-800' },
        ];

        // é©¬å¡é¾™/ç³–æœè‰²ç³»ï¼šç²‰ã€æ¡ƒã€ç´«ã€å¤©è“ã€å¥¶é»„
        const PIE_COLORS = ['#fb7185', '#f472b6', '#c084fc', '#60a5fa', '#fbbf24', '#34d399', '#818cf8', '#fb923c', '#a78bfa', '#f87171', '#2dd4bf', '#facc15'];

        const PRESET_ACCOUNTS = [
            { name: 'é“¶è¡Œå¡', icon: 'card', isLiquid: true, type: 'asset', color: 'bg-indigo-600' },
            { name: 'æ”¯ä»˜å®', icon: 'scan', isLiquid: true, type: 'asset', color: 'bg-blue-500' },
            { name: 'å¾®ä¿¡', icon: 'message', isLiquid: true, type: 'asset', color: 'bg-green-600' },
            { name: 'åŸºé‡‘', icon: 'pieChart', isLiquid: false, type: 'asset', color: 'bg-red-500' },
            { name: 'è‚¡ç¥¨', icon: 'chartLine', isLiquid: false, type: 'asset', color: 'bg-red-600' },
        ];

        // --- Custom Select Component (Beautified) ---
        const CustomSelect = ({ options, value, onChange, placeholder = "è¯·é€‰æ‹©" }) => {
          const [isOpen, setIsOpen] = useState(false);
          const containerRef = useRef(null);

          useEffect(() => {
            const handleClickOutside = (event) => {
              if (containerRef.current && !containerRef.current.contains(event.target)) {
                setIsOpen(false);
              }
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, []);

          const selectedOption = options.find(o => o.value === value);

          return (
            <div className="relative w-full" ref={containerRef}>
              <div 
                className="w-full bg-stone-50 p-3 rounded-xl border border-stone-200 flex justify-between items-center text-sm font-bold text-stone-800 cursor-pointer active:scale-[0.99] transition-all"
                onClick={() => setIsOpen(!isOpen)}
              >
                <span className={!selectedOption ? "text-stone-400" : ""}>
                  {selectedOption ? selectedOption.label : placeholder}
                </span>
                <Icon name="chevronDown" size={16} className={`text-stone-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
              </div>
              
              {isOpen && (
                <div className="absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-xl border border-stone-100 z-50 overflow-hidden max-h-60 overflow-y-auto animate-slide-up">
                  {options.map(opt => (
                    <div 
                      key={opt.value}
                      className={`p-3 text-sm font-medium flex flex-col cursor-pointer hover:bg-stone-50 transition-colors ${opt.value === value ? 'bg-emerald-50 text-emerald-700' : 'text-stone-600'}`}
                      onClick={() => { onChange(opt.value); setIsOpen(false); }}
                    >
                      <div className="flex justify-between items-center w-full">
                        <span className="truncate">{opt.label}</span>
                        {opt.value === value && <Icon name="check" size={14} className="text-emerald-600 flex-shrink-0" />}
                      </div>
                      {opt.subLabel && <span className="text-[10px] opacity-60 font-normal">{opt.subLabel}</span>}
                    </div>
                  ))}
                </div>
              )}
            </div>
          );
        };

        const Modal = ({ isOpen, title, content, type = 'confirm', inputValue, setInputValue, onConfirm, onCancel, confirmText = "ç¡®å®š" }) => {
                    if (!isOpen) return null;
                    return (
                        <div className="fixed inset-0 bg-stone-900/40 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-3xl w-full max-w-xs p-6 shadow-2xl border border-rose-100 animate-slide-up relative overflow-hidden">
                                {/* é¡¶éƒ¨è£…é¥°å…‰æ™• */}
                                <div className="absolute top-0 right-0 w-20 h-20 bg-rose-100 rounded-full blur-2xl -mr-10 -mt-10 opacity-50 pointer-events-none"></div>
                                
                                <h3 className="text-lg font-bold text-stone-800 mb-3 flex items-center gap-2 relative z-10">
                                    {type === 'alert' && <Icon name="info" className="text-rose-400" />}
                                    {type === 'delete' && <Icon name="trash2" className="text-red-400" />}
                                    {(!['alert', 'delete'].includes(type)) && <Icon name="heart" className="text-rose-400" />}
                                    {title}
                                </h3>
                                
                                {content && <p className="text-sm text-stone-600 mb-6 leading-relaxed relative z-10">{content}</p>}
                                
                                {type === 'input' && (
                                    <input 
                                        autoFocus 
                                        type="text" 
                                        value={inputValue} 
                                        onChange={(e) => setInputValue(e.target.value)} 
                                        className="w-full bg-stone-50 border-2 border-transparent focus:border-rose-300 focus:bg-white rounded-2xl px-4 py-3 text-stone-800 outline-none mb-6 transition-all font-bold text-sm placeholder-stone-300" 
                                        placeholder="åœ¨æ­¤è¾“å…¥..." 
                                    />
                                )}
                                
                                <div className="flex gap-3 relative z-10">
                                    {type !== 'alert' && (
                                        <button onClick={onCancel} className="flex-1 py-3 rounded-2xl bg-stone-50 text-stone-500 font-bold text-sm hover:bg-stone-100 active:scale-95 transition-all">
                                            å–æ¶ˆ
                                        </button>
                                    )}
                                    <button onClick={onConfirm} className={`flex-1 py-3 rounded-2xl text-white font-bold text-sm shadow-lg active:scale-95 transition-all ${
                                        type === 'delete' 
                                            ? 'bg-red-400 shadow-red-200' 
                                            : 'bg-gradient-to-r from-rose-400 to-pink-500 shadow-rose-200'
                                    } ${type === 'alert' ? 'w-full' : ''}`}>
                                        {confirmText}
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                };

        const PieChartComponent = ({ data, emptyMessage = "æš‚æ— æ•°æ®" }) => {
            const total = data.reduce((acc, item) => acc + item.value, 0);
            if (total <= 0) return <div className="flex flex-col items-center justify-center py-10 text-stone-300"><div className="w-32 h-32 rounded-full border-4 border-stone-100 mb-2"></div><span className="text-xs">{emptyMessage}</span></div>;
            let startAngle = 0; const radius = 50; const cx = 50; const cy = 50;
            return (
                <div className="flex flex-row items-center justify-between gap-4">
                    <div className="relative w-40 h-40 flex-shrink-0">
                        <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                            {data.map((item, index) => {
                                if (item.value <= 0) return null;
                                const sliceAngle = (item.value / total) * 360;
                                if (sliceAngle > 359.9) return <circle key={index} cx="50" cy="50" r="50" fill={item.color} />;
                                const x1 = cx + radius * Math.cos((Math.PI * startAngle) / 180); const y1 = cy + radius * Math.sin((Math.PI * startAngle) / 180);
                                const x2 = cx + radius * Math.cos((Math.PI * (startAngle + sliceAngle)) / 180); const y2 = cy + radius * Math.sin((Math.PI * (startAngle + sliceAngle)) / 180);
                                const largeArc = sliceAngle > 180 ? 1 : 0;
                                const pathData = `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                startAngle += sliceAngle;
                                return <path key={index} d={pathData} fill={item.color} stroke="white" strokeWidth="1" />;
                            })}
                            <circle cx="50" cy="50" r="30" fill="white" />
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center flex-col pointer-events-none"><span className="text-[10px] text-stone-400">æ€»è®¡</span><span className="text-sm font-bold text-stone-800">Â¥{total.toLocaleString()}</span></div>
                    </div>
                    <div className="flex-1 space-y-2 max-h-40 overflow-y-auto no-scrollbar">
                        {data.map((item, index) => (
                            <div key={index} className="flex items-center justify-between text-xs">
                                <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full" style={{ backgroundColor: item.color }}></span><span className="text-stone-600 truncate max-w-[80px]">{item.name}</span></div>
                                <span className="font-bold text-stone-800">{(item.value / total * 100).toFixed(2)}%</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const IconPicker = ({ selectedIcon, onSelect, onClose }) => (
            <div className="fixed inset-0 bg-black/50 z-[80] flex items-end sm:items-center justify-center animate-fade-in">
                <div className="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl p-6 max-h-[70vh] overflow-y-auto">
                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-stone-800">é€‰æ‹©å›¾æ ‡</h3><button onClick={onClose}><Icon name="x" size={24} className="text-stone-400" /></button></div>
                    <div className="grid grid-cols-5 gap-4">
                        {ICON_KEYS.map(key => (
                            <button key={key} onClick={() => onSelect(key)} className={`p-3 rounded-xl flex items-center justify-center transition-all ${selectedIcon === key ? 'bg-emerald-100 text-emerald-700 ring-2 ring-emerald-600' : 'bg-stone-50 text-stone-600 hover:bg-stone-100'}`}>
                                <Icon name={key} size={24} />
                            </button>
                        ))}
                    </div>
                </div>
            </div>
        );

        const HomeView = ({ netWorth, liquidBalance, transactions, accounts, categories, setShowManageAssets, onEditTransaction, onDeleteTransaction }) => {
                    const currentMonthStats = useMemo(() => {
                        const now = new Date();
                        const monthlyTrans = transactions.filter(t => {
                            const d = new Date(t.date);
                            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                        });
                        const income = monthlyTrans.filter(t => t.type === 'income').reduce((acc, t) => acc + Number(t.amount), 0);
                        const expense = monthlyTrans.filter(t => t.type === 'expense').reduce((acc, t) => acc + Number(t.amount), 0);
                        return { income, expense };
                    }, [transactions]);
        
                    const sortedTransactions = useMemo(() => {
                        return [...transactions].sort((a, b) => {
                            const dateA = new Date(a.date);
                            const dateB = new Date(b.date);
                            if (dateA.getTime() !== dateB.getTime()) return dateB - dateA;
                            return b.id - a.id;
                        });
                    }, [transactions]);
        
                    return (
                        <div className="pb-24 animate-fade-in">
                            {/* UIä¿®æ”¹é‡ç‚¹ï¼š
                                1. èƒŒæ™¯æ”¹ä¸º from-rose-400 to-pink-500 (ç«ç‘°ç²‰åˆ°æ·±ç²‰æ¸å˜)
                                2. é˜´å½±æ”¹ä¸º shadow-pink-200
                                3. è£…é¥°å›¾æ ‡æ”¹ä¸º sakura
                            */}
                            <div className="bg-gradient-to-br from-rose-400 to-pink-500 text-white p-6 rounded-b-[2.5rem] shadow-xl shadow-pink-200 mb-6 pt-6 relative overflow-hidden">
                                
                                {/* èƒŒæ™¯è£…é¥°åœ†ç¯ - å¢åŠ æ°›å›´æ„Ÿ */}
                                <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                                <div className="absolute top-20 -left-10 w-32 h-32 bg-rose-300/20 rounded-full blur-xl"></div>
        
                                <div className="relative z-20 flex justify-center items-center mb-6">
                                    <div className="relative">
                                        <span className="text-xl font-serif font-bold tracking-widest text-white border-b-2 border-white/30 pb-1 px-4">
                                            é’æ¾è®°è´¦
                                        </span>
                                        <div className="absolute -right-8 -top-2 text-pink-200 animate-pulse">
                                             {/* å°ºå¯¸ç¨å¾®è°ƒå¤§åˆ° 28ï¼Œä½ç½®ä¹Ÿå¾®è°ƒäº†ä¸€ä¸‹ */}
                                            <Icon name="twoHearts" size={40} />
                                        </div>
                                        
                                    </div>
                                </div>
                                <div className="relative z-10">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <div className="text-pink-100 text-xs mb-1 font-medium tracking-wider">æˆ‘çš„å°é‡‘åº“ (æ€»èµ„äº§)</div>
                                            <div className="text-4xl font-bold mb-3 font-mono tracking-tight drop-shadow-sm">Â¥ {netWorth.toLocaleString()}</div>
                                            <div className="text-rose-600 text-xs font-bold bg-white/90 inline-block px-3 py-1.5 rounded-full shadow-sm">
                                                é›¶èŠ±é’±: Â¥ {liquidBalance.toLocaleString()}
                                            </div>
                                        </div>
                                        <button onClick={() => setShowManageAssets(true)} className="bg-white/20 hover:bg-white/30 backdrop-blur-sm p-2 rounded-full border border-white/40 transition-all">
                                            <Icon name="settings" size={20} className="text-white" />
                                        </button>
                                    </div>
                                    
                                    {/* æœ¬æœˆæ”¶æ”¯å¡ç‰‡ - åŠé€æ˜ç£¨ç ‚ */}
                                    <div className="flex justify-between bg-white/10 p-4 rounded-2xl backdrop-blur-md border border-white/20 mt-6 shadow-inner">
                                        <div className="flex-1 border-r border-white/20 pr-4">
                                            <div className="flex items-center text-pink-100 text-xs mb-1"><Icon name="trendingUp" size={14} className="mr-1" /> æœ¬æœˆè¿›è´¦</div>
                                            <div className="text-lg font-semibold text-white">Â¥ {currentMonthStats.income.toLocaleString()}</div>
                                        </div>
                                        <div className="flex-1 pl-4">
                                            <div className="flex items-center text-pink-100 text-xs mb-1"><Icon name="shopping" size={14} className="mr-1" /> æœ¬æœˆèŠ±é”€</div>
                                            <div className="text-lg font-semibold text-white">Â¥ {currentMonthStats.expense.toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
        
                            <div className="px-5">
                                <h2 className="text-lg font-bold text-stone-700 mb-4 flex items-center gap-2">
                                    <Icon name="list" size={18} className="text-rose-400"/> 
                                    è¿‘æœŸæ˜ç»†
                                </h2>
                                <div className="space-y-3">
                                    {sortedTransactions.length === 0 ? (
                                        <div className="text-center py-12 bg-white/50 rounded-3xl border-2 border-dashed border-rose-200">
                                            <div className="text-rose-300 mb-2 text-sm">è¿˜æ²¡æœ‰è®°è´¦å“¦ï¼Œå»ä¹°æ¯å¥¶èŒ¶å§~ ğŸŒ¸</div>
                                        </div>
                                    ) : (sortedTransactions.map((t) => {
                                        // ...æ­¤å¤„ä¿ç•™åŸæœ‰çš„è½¬è´¦é€»è¾‘ï¼Œä»£ç çœç•¥...
                                        // é‡ç‚¹ï¼šå°†åŸæœ‰çš„ category æ¸²æŸ“éƒ¨åˆ†ç¨å¾®è°ƒæ•´æ ·å¼
                                        if (t.type === 'transfer') { /* ...åŸä»£ç ... */ return (/* ...åŸä»£ç ... */ <div key={t.id} className="bg-white p-4 rounded-2xl shadow-sm border border-rose-100/50 flex items-center justify-between group"> ... </div>)}
        
                                        const catList = t.type === 'income' ? categories.income : categories.expense;
                                        const category = catList.find(c => c.id === t.category) || { name: 'æœªçŸ¥', iconKey: 'more', color: 'bg-gray-200' };
                                        const account = accounts.find(a => a.id === t.accountId);
                                        const ledgerTag = t.ledgerId && t.ledgerId !== 'default' ? <span className="text-[10px] bg-pink-50 text-pink-500 px-1 rounded ml-1">ä¸“é¡¹</span> : null;
                                        return (
                                            <div key={t.id} className="bg-white p-4 rounded-2xl shadow-sm border border-rose-100/50 flex items-center justify-between group hover:shadow-md transition-all">
                                                <div className="flex items-center gap-3">
                                                    {/* å›¾æ ‡èƒŒæ™¯æ”¹ä¸ºåœ†å½¢ */}
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${category.color} shadow-sm`}>
                                                        <Icon name={category.iconKey} size={20} />
                                                    </div>
                                                    <div>
                                                        <div className="font-bold text-stone-700 flex items-center">{category.name} {ledgerTag}</div>
                                                        <div className="text-xs text-stone-400 flex items-center gap-2">
                                                            <span className="bg-stone-50 px-1.5 py-0.5 rounded text-stone-400">{account?.name}</span>
                                                            <span>{new Date(t.date).toLocaleDateString().replace(/\//g, '.')}</span>
                                                            {t.note && <span className="text-stone-400 truncate max-w-[80px]">Â· {t.note}</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex flex-col items-end">
                                                    <span className={`font-bold text-lg font-mono ${t.type === 'income' ? 'text-rose-500' : 'text-stone-800'}`}>
                                                        {t.type === 'income' ? '+' : '-'} {Number(t.amount).toLocaleString()}
                                                    </span>
                                                    {/* ç¼–è¾‘åˆ é™¤æŒ‰é’®ä¿æŒä¸å˜ï¼Œé¢œè‰²ä¼šè‡ªåŠ¨ç»§æ‰¿ */}
                                                    <div className="flex gap-2 mt-1"><button onClick={() => onEditTransaction(t)} className="text-rose-200 p-1 hover:text-rose-500 transition-colors"><Icon name="edit2" size={16} /></button><button onClick={() => onDeleteTransaction(t.id)} className="text-rose-200 p-1 hover:text-rose-500 transition-colors"><Icon name="trash2" size={16} /></button></div>
                                                </div>
                                            </div>
                                        );
                                    }))}
                                </div>
                            </div>
                        </div>
                    );
                };

        const AddView = ({ accounts, categories, ledgers, onSaveTransaction, editingTransaction, onCancelEdit, onAddCategoryClick, onDeleteCategory, onSetCategories, ledgerOptions, templates, onSaveTemplate, onDeleteTemplate, openAlert }) => {
                    const [type, setType] = useState('expense');
                    const [amount, setAmount] = useState('');
                    const [category, setCategory] = useState('');
                    const [accountId, setAccountId] = useState(accounts[0]?.id || '');
                    const [ledgerId, setLedgerId] = useState(ledgers[0]?.id || 'default');
                    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
                    const [note, setNote] = useState('');
                    const [showManageCats, setShowManageCats] = useState(false);
                    const [pickingIconForCat, setPickingIconForCat] = useState(null);
                    
                    // æ¨¡æ¿ä¿å­˜ç›¸å…³çš„çŠ¶æ€
                    const [showSaveTemplateModal, setShowSaveTemplateModal] = useState(false);
                    const [newTemplateName, setNewTemplateName] = useState('');
        
                    const amountInputRef = useRef(null);
        
                    // çˆ±å¿ƒé›¨å·¥å…·
                    const triggerHeartRain = () => {
                        const container = document.body;
                        const hearts = ['â¤ï¸', 'ğŸ’–', 'ğŸŒ¸', 'ğŸ˜˜', 'âœ¨', 'ğŸ¬'];
                        for (let i = 0; i < 30; i++) {
                            const el = document.createElement('div');
                            el.innerText = hearts[Math.floor(Math.random() * hearts.length)];
                            el.style.position = 'fixed';
                            el.style.left = Math.random() * 100 + 'vw';
                            el.style.top = '-50px';
                            el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                            el.style.zIndex = '9999';
                            el.style.pointerEvents = 'none';
                            el.style.transition = `transform ${Math.random() * 2 + 2}s linear, opacity 2s ease-in`;
                            container.appendChild(el);
                            requestAnimationFrame(() => { el.style.transform = `translateY(${window.innerHeight + 100}px) rotate(${Math.random() * 360}deg)`; el.style.opacity = '0'; });
                            setTimeout(() => { container.removeChild(el); }, 4000);
                        }
                    };
        
                    useEffect(() => {
                        if (editingTransaction) {
                            setType(editingTransaction.type); setAmount(editingTransaction.amount); setCategory(editingTransaction.category);
                            setAccountId(editingTransaction.accountId); setLedgerId(editingTransaction.ledgerId || 'default');
                            setDate(editingTransaction.date); setNote(editingTransaction.note || '');
                        }
                    }, [editingTransaction]);
        
                    useEffect(() => {
                        if (!editingTransaction && !pickingIconForCat && !showSaveTemplateModal) { const timer = setTimeout(() => amountInputRef.current?.focus(), 100); return () => clearTimeout(timer); }
                    }, [editingTransaction, pickingIconForCat, showSaveTemplateModal]);
        
                    const currentCategories = type === 'expense' ? categories.expense : categories.income;
                    const handleSubmit = () => { if (!amount || !category || !accountId) return; onSaveTransaction({ type, amount: parseFloat(amount), category, accountId, ledgerId, date, note }); };
                    const handleIconSelect = (iconKey) => { if (!pickingIconForCat) return; onSetCategories(prev => ({ ...prev, [type]: prev[type].map(c => c.id === pickingIconForCat ? { ...c, iconKey } : c) })); setPickingIconForCat(null); };
        
                    const handleApplyTemplate = (tpl) => {
                        setType(tpl.type);
                        setAmount(tpl.amount);
                        setCategory(tpl.category);
                        setAccountId(tpl.accountId);
                        setLedgerId(tpl.ledgerId || 'default');
                        setNote(tpl.note || '');
                    };
        
                    const handleCreateTemplate = () => {
                        if (!amount || !category || !accountId || !newTemplateName) return;
                        onSaveTemplate({ name: newTemplateName, type, amount, category, accountId, ledgerId, note });
                        setNewTemplateName('');
                        setShowSaveTemplateModal(false);
                    };
        
                    return (
                        <div className="pb-24 pt-6 px-5 h-full flex flex-col animate-fade-in bg-[#fff1f2]">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-2xl font-bold text-stone-800 flex items-center gap-2">
                                    <Icon name="edit2" className="text-rose-500" /> 
                                    {editingTransaction ? 'ä¿®æ”¹å°è´¦æœ¬' : 'è®°ä¸€ç¬”'}
                                </h2>
                                <div className="flex gap-2">
                                    {!editingTransaction && (
                                        <button onClick={() => { 
                                            if(!amount || !category){ 
                                                // ä¿®æ”¹ï¼šä½¿ç”¨ openAlert æ›¿ä»£åŸç”Ÿ alert
                                                openAlert("æç¤º", "å®ï¼Œå…ˆå¡«å¥½é‡‘é¢å’Œåˆ†ç±»å†å­˜æ¨¡æ¿å“¦~"); 
                                                return;
                                            } 
                                            setShowSaveTemplateModal(true); 
                                        }} className="text-xs bg-rose-100 text-rose-500 px-3 py-1.5 rounded-full font-bold flex items-center gap-1 active:scale-95 transition-all border border-rose-200 shadow-sm hover:bg-rose-200">
                                            <Icon name="bookmark" size={14} /> å­˜ä¸ºé€Ÿè®°
                                        </button>
                                    )}
                                    {editingTransaction && <button onClick={onCancelEdit} className="text-sm text-rose-400 font-bold px-3 py-1 bg-rose-100 rounded-lg">å–æ¶ˆä¿®æ”¹</button>}
                                </div>
                            </div>
        
                            {templates && templates.length > 0 && !editingTransaction && (
                                <div className="mb-4">
                                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 px-1">
                                        {templates.map(tpl => (
                                            <div key={tpl.id} className="relative group flex-shrink-0 animate-fade-in">
                                                <button onClick={() => handleApplyTemplate(tpl)} className="px-3 py-1.5 rounded-xl border border-rose-100 bg-white text-rose-500 text-xs font-bold flex items-center gap-1 transition-all active:scale-95 shadow-sm hover:shadow-md hover:border-rose-300">
                                                    <Icon name="bookmark" size={12} className="text-rose-300"/>{tpl.name}
                                                </button>
                                                <button onClick={(e) => { e.stopPropagation(); onDeleteTemplate(tpl.id); }} className="absolute -top-1.5 -right-1.5 w-4 h-4 bg-rose-50 text-rose-400 rounded-full flex items-center justify-center border border-white shadow-sm z-10 hover:bg-red-50 hover:text-red-500">
                                                    <Icon name="x" size={8} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
        
                            <div className="bg-rose-100/50 p-1 rounded-2xl flex mb-6 border border-rose-100">
                                <button className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${type === 'expense' ? 'bg-white shadow-sm text-rose-500' : 'text-stone-400 hover:text-rose-300'}`} onClick={() => { setType('expense'); setCategory(''); }}>æ”¯å‡º</button>
                                <button className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${type === 'income' ? 'bg-white shadow-sm text-rose-500' : 'text-stone-400 hover:text-rose-300'}`} onClick={() => { setType('income'); setCategory(''); }}>æ”¶å…¥</button>
                            </div>
        
                            <div className="flex gap-3 mb-2">
                                <div className="flex-[1.3] bg-white rounded-3xl p-3 shadow-sm border border-stone-100 focus-within:border-rose-300 focus-within:ring-2 focus-within:ring-rose-100 transition-all">
                                    <label className="text-[10px] text-stone-400 font-bold uppercase tracking-wider mb-1 block">é‡‘é¢</label>
                                    <div className="flex items-center">
                                        <span className="text-2xl font-bold text-rose-300 mr-2">Â¥</span>
                                        <input ref={amountInputRef} type="number" inputMode="decimal" value={amount} onChange={e => {
                                                const val = e.target.value; setAmount(val);
                                                if (val === '520' || val === '1314' || val === '5.20' || val === '13.14') { triggerHeartRain(); }
                                            }} className="w-full text-3xl font-bold text-stone-800 placeholder-stone-200 outline-none focus:outline-none focus:ring-0 border-none bg-transparent" placeholder="0.00" />
                                    </div>
                                </div>
                                <div className="flex-1 bg-white rounded-3xl p-3 shadow-sm border border-stone-100 flex flex-col justify-center min-w-0">
                                    <label className="text-[10px] text-stone-500 font-bold mb-1 block ml-1">æ‰€å±è´¦æœ¬</label>
                                    <CustomSelect options={ledgerOptions} value={ledgerId} onChange={setLedgerId} />
                                </div>
                            </div>
        
                            <div className="mb-3">
                                <label className="text-xs text-stone-500 font-bold mb-2 block ml-1">è´¦æˆ·</label>
                                <div className="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                                    {accounts.map(acc => ( 
                                        <button key={acc.id} onClick={() => setAccountId(acc.id)} className={`flex items-center gap-2 px-4 py-2 rounded-xl border transition-all whitespace-nowrap ${accountId === acc.id ? 'bg-rose-500 text-white border-rose-500 shadow-md shadow-rose-200' : 'bg-white text-stone-500 border-stone-200'}`}>
                                            <span className={`w-2 h-2 rounded-full ${acc.color}`}></span>{acc.name}
                                        </button> 
                                    ))}
                                </div>
                            </div>
        
                            <div className="flex-1 overflow-y-auto mb-4 min-h-0">
                                <div className="flex justify-between items-center mb-2 px-1">
                                    <label className="text-xs text-stone-500 font-bold">åˆ†ç±»</label>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowManageCats(!showManageCats)} className="text-xs text-rose-500 font-bold">{showManageCats ? 'å®Œæˆ' : 'ç®¡ç†'}</button>
                                        {showManageCats && <button onClick={() => onAddCategoryClick(type)} className="text-xs bg-rose-100 text-rose-600 px-2 rounded hover:bg-rose-200">+ æ–°å¢</button>}
                                    </div>
                                </div>
                                <div className="grid grid-cols-4 gap-3 content-start pb-4">
                                    {currentCategories.map(c => {
                                        const isSelected = category === c.id;
                                        return (
                                            <div key={c.id} className="relative group">
                                                <button onClick={() => setCategory(c.id)} className={`w-full flex flex-col items-center justify-center p-3 rounded-2xl transition-all ${isSelected ? 'bg-rose-500 text-white shadow-lg shadow-rose-200 scale-105' : 'bg-white text-stone-500 hover:bg-rose-50'}`}>
                                                    <div className={`mb-1 ${isSelected ? 'text-white' : ''}`}><Icon name={c.iconKey} size={24} /></div>
                                                    <span className="text-xs font-medium truncate w-full text-center">{c.name}</span>
                                                </button>
                                                {showManageCats && (<div className="absolute -top-2 -right-2 flex gap-1 z-10"><button onClick={(e) => { e.stopPropagation(); setPickingIconForCat(c.id); }} className="bg-blue-100 text-blue-600 rounded-full p-1 shadow"><Icon name="edit2" size={10} /></button><button onClick={(e) => { e.stopPropagation(); onDeleteCategory(type, c.id); }} className="bg-red-100 text-red-600 rounded-full p-1 shadow"><Icon name="x" size={10} /></button></div>)}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
        
                            <div className="bg-white/80 backdrop-blur-md p-4 rounded-t-3xl shadow-[0_-5px_20px_rgba(251,113,133,0.15)] -mx-5 px-5 border-t border-rose-100">
                                <div className="flex gap-3 mb-4">
                                    <div className="flex-1 bg-stone-50/50 rounded-xl px-3 py-2 border border-stone-100 focus-within:border-rose-300 focus-within:bg-white transition-colors">
                                        <span className="text-[10px] text-stone-400 font-bold uppercase block">æ—¥æœŸ</span>
                                        <input type="date" value={date} onChange={e => setDate(e.target.value)} className="bg-transparent text-sm font-bold text-stone-700 outline-none w-full" />
                                    </div>
                                    <div className="flex-[2] bg-stone-50/50 rounded-xl px-3 py-2 border border-stone-100 focus-within:border-rose-300 focus-within:bg-white transition-colors">
                                        <span className="text-[10px] text-stone-400 font-bold uppercase block">å¤‡æ³¨</span>
                                        <input type="text" value={note} onChange={e => setNote(e.target.value)} placeholder="å†™ç‚¹ä»€ä¹ˆ..." className="bg-transparent text-sm text-stone-700 outline-none w-full" />
                                    </div>
                                </div>
                                <button onClick={handleSubmit} disabled={!amount || !category || !accountId} className="w-full bg-gradient-to-r from-rose-400 to-pink-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-pink-200 active:scale-95 transition-all disabled:opacity-50 disabled:shadow-none flex items-center justify-center gap-2">
                                    <Icon name="check" strokeWidth={3} size={20} /> {editingTransaction ? 'ä¿å­˜ä¿®æ”¹' : 'ç¡®è®¤è®°è´¦'}
                                </button>
                            </div>
                            {pickingIconForCat && <IconPicker selectedIcon={currentCategories.find(c => c.id === pickingIconForCat)?.iconKey} onSelect={handleIconSelect} onClose={() => setPickingIconForCat(null)} />}
                        
                            {/* ä¿®æ”¹ï¼šä¿å­˜æ¨¡æ¿å¼¹çª— (æ ·å¼å®Œå…¨ç»Ÿä¸€) */}
                            {showSaveTemplateModal && (
                                <div className="fixed inset-0 bg-stone-900/40 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                                    <div className="bg-white rounded-3xl w-full max-w-xs p-6 shadow-2xl border border-rose-100 animate-slide-up relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-20 h-20 bg-rose-100 rounded-full blur-2xl -mr-10 -mt-10 opacity-50 pointer-events-none"></div>
                                        <h3 className="text-lg font-bold text-stone-800 mb-3 flex items-center gap-2 relative z-10">
                                            <Icon name="bookmark" className="text-rose-400" /> å­˜ä¸ºé€Ÿè®°
                                        </h3>
                                        <input 
                                            autoFocus 
                                            placeholder="ç»™æ¨¡æ¿å–ä¸ªåå­—å§ (å¦‚: é€šå‹¤)" 
                                            className="w-full bg-stone-50 border-2 border-transparent focus:border-rose-300 focus:bg-white rounded-2xl px-4 py-3 text-stone-800 outline-none mb-6 transition-all font-bold text-sm placeholder-stone-300 relative z-10" 
                                            value={newTemplateName} 
                                            onChange={e => setNewTemplateName(e.target.value)} 
                                        />
                                        <div className="flex gap-3 relative z-10">
                                            <button onClick={() => setShowSaveTemplateModal(false)} className="flex-1 py-3 rounded-2xl bg-stone-50 text-stone-500 font-bold text-sm hover:bg-stone-100 active:scale-95 transition-all">å–æ¶ˆ</button>
                                            <button onClick={handleCreateTemplate} disabled={!newTemplateName} className="flex-1 py-3 rounded-2xl text-white font-bold text-sm shadow-lg shadow-rose-200 bg-gradient-to-r from-rose-400 to-pink-500 active:scale-95 transition-all disabled:opacity-50">ä¿å­˜</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                };

        // --- ä¿®æ”¹ 1: æ›´æ–° SpecialLedgersView ç»„ä»¶ ---
                const SpecialLedgersView = ({ ledgers, categories, transactions, onAddLedger, onDeleteLedger }) => {
                            const [showAdd, setShowAdd] = useState(false);
                            const [newLedgerName, setNewLedgerName] = useState('');
                            const presets = [
                                { name: 'æ—…æ¸¸', icon: 'plane', color: 'bg-cyan-400' },
                                { name: 'ç»è¥', icon: 'store', color: 'bg-indigo-400' },
                                { name: 'é‡‡è´­', icon: 'shopping', color: 'bg-pink-400' },
                                { name: 'è£…ä¿®', icon: 'hammer', color: 'bg-orange-400' }
                            ];
                            
                            const handleCreate = (name = newLedgerName, preset = null) => { 
                                if (!name) return; 
                                onAddLedger({ 
                                    name, 
                                    iconKey: preset ? preset.icon : 'book', 
                                    color: preset ? preset.color : 'bg-rose-400' 
                                }); 
                                setNewLedgerName(''); 
                                setShowAdd(false); 
                            };
                            
                            const [selectedId, setSelectedId] = useState(null);
                            const selectedLedger = ledgers.find(l => l.id === selectedId);
                
                            if (selectedId && !selectedLedger) {
                                setSelectedId(null);
                                return null; 
                            }
                
                            // --- è¯¦æƒ…é¡µè§†å›¾ (è¿›å…¥æŸä¸ªè´¦æœ¬å) ---
                            if (selectedId && selectedLedger) {
                                const ledgerTrans = transactions.filter(t => t.ledgerId === selectedId).sort((a, b) => new Date(b.date) - new Date(a.date));
                                const income = ledgerTrans.filter(t => t.type === 'income').reduce((acc, t) => acc + Number(t.amount), 0);
                                const expense = ledgerTrans.filter(t => t.type === 'expense').reduce((acc, t) => acc + Number(t.amount), 0);
                                
                                return (
                                    <div className="h-full flex flex-col bg-[#fff1f2] animate-fade-in pb-24">
                                        {/* è¯¦æƒ…é¡µå¤´éƒ¨ */}
                                        <div className={`${selectedLedger.color} text-white p-6 rounded-b-[2.5rem] shadow-xl shadow-rose-100 pt-12 relative overflow-hidden`}>
                                            {/* è£…é¥°å±‚ (z-0) */}
                                            <div className="absolute -top-6 -right-6 w-32 h-32 bg-white/20 rounded-full blur-2xl pointer-events-none"></div>
                                            <div className="absolute top-10 -left-6 w-24 h-24 bg-white/10 rounded-full blur-xl pointer-events-none"></div>
                
                                            {/* --- ä¿®å¤ç‚¹ï¼šæ·»åŠ  z-50 ç¡®ä¿æŒ‰é’®åœ¨æœ€ä¸Šå±‚ --- */}
                                            
                                            {/* è¿”å›æŒ‰é’® */}
                                            <button onClick={() => setSelectedId(null)} className="absolute left-6 top-12 bg-white/20 p-2.5 rounded-full hover:bg-white/30 transition-all backdrop-blur-sm z-50 active:scale-90">
                                                <Icon name="chevronLeft" size={20} strokeWidth={3}/>
                                            </button>
                                            
                                            {/* åˆ é™¤æŒ‰é’® */}
                                            {selectedId !== 'default' && (
                                                <button onClick={() => onDeleteLedger(selectedId)} className="absolute right-6 top-12 bg-white/20 p-2.5 rounded-full hover:bg-red-500/50 transition-colors backdrop-blur-sm z-50 active:scale-90">
                                                    <Icon name="trash2" size={20}/>
                                                </button>
                                            )}
                                            
                                            {/* æ ‡é¢˜å†…å®¹ (z-10) */}
                                            <div className="flex flex-col items-center mb-6 mt-2 relative z-10 pointer-events-none"> 
                                                {/* pointer-events-none é˜²æ­¢æ–‡å­—å±‚æŒ¡ä½å·¦å³ä¸¤ä¾§çš„æŒ‰é’®ç‚¹å‡»åŒºåŸŸ */}
                                                <div className="bg-white/20 p-4 rounded-full mb-3 shadow-inner ring-4 ring-white/10">
                                                    <Icon name={selectedLedger.iconKey} size={32} />
                                                </div>
                                                <h2 className="text-2xl font-bold tracking-wide text-shadow-sm">{selectedLedger.name}</h2>
                                            </div>
                
                                            {/* æ”¶æ”¯æ•°æ® (z-10) */}
                                            <div className="flex gap-4 relative z-10">
                                                <div className="flex-1 bg-white/10 p-3 rounded-2xl backdrop-blur-md border border-white/20 shadow-inner">
                                                    <div className="text-xs opacity-90 mb-1 flex items-center gap-1"><Icon name="trendingDown" size={12}/> æ€»æ”¯å‡º</div>
                                                    <div className="text-xl font-bold font-mono">Â¥ {expense.toLocaleString()}</div>
                                                </div>
                                                <div className="flex-1 bg-white/10 p-3 rounded-2xl backdrop-blur-md border border-white/20 shadow-inner">
                                                    <div className="text-xs opacity-90 mb-1 flex items-center gap-1"><Icon name="trendingUp" size={12}/> æ€»æ”¶å…¥</div>
                                                    <div className="text-xl font-bold font-mono">Â¥ {income.toLocaleString()}</div>
                                                </div>
                                            </div>
                                        </div>
                
                                        {/* äº¤æ˜“åˆ—è¡¨ */}
                                        <div className="flex-1 overflow-y-auto p-5 space-y-3">
                                            {ledgerTrans.length === 0 && (
                                                <div className="text-center text-rose-300 mt-20 flex flex-col items-center gap-2 opacity-60">
                                                    <Icon name="book" size={40} />
                                                    <span className="text-sm">è¿™ä¸ªè´¦æœ¬è¿˜æ˜¯ç©ºçš„å‘¢~</span>
                                                </div>
                                            )}
                                            {ledgerTrans.map(t => {
                                                const catList = t.type === 'income' ? categories.income : categories.expense;
                                                const category = catList.find(c => c.id === t.category);
                                                const displayName = category ? category.name : 'æœªçŸ¥åˆ†ç±»';
                                                return (
                                                    <div key={t.id} className="bg-white p-4 rounded-2xl shadow-sm border border-rose-100 flex justify-between items-center group hover:shadow-md transition-all">
                                                        <div>
                                                            <div className="font-bold text-stone-700 flex items-center gap-2">
                                                                {displayName}
                                                                {t.note && <span className="text-xs font-normal text-rose-400 bg-rose-50 px-1.5 rounded-md">{t.note}</span>}
                                                            </div>
                                                            <div className="text-xs text-stone-400 mt-1">{new Date(t.date).toLocaleDateString().replace(/\//g, '.')}</div>
                                                        </div>
                                                        <div className={`font-bold font-mono text-lg ${t.type==='income'?'text-rose-500':'text-stone-600'}`}>
                                                            {t.type==='income'?'+':'-'} {Number(t.amount).toLocaleString()}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            }
                
                            // --- åˆ—è¡¨é¡µè§†å›¾ (ä¸»ç•Œé¢) ---
                            return (
                                <div className="h-full flex flex-col bg-[#fff1f2] animate-fade-in p-5 pt-12 pb-24">
                                    {/* å¤´éƒ¨åŒºåŸŸï¼šæ·»åŠ  z-index ç¡®ä¿æŒ‰é’®å¯ç‚¹ */}
                                    <div className="flex justify-between items-center mb-8 px-1 relative z-50">
                                        <div>
                                            <h2 className="text-2xl font-bold text-stone-800 flex items-center gap-2">
                                                <Icon name="book" className="text-rose-500" />
                                                ä¸“å±è´¦æœ¬
                                            </h2>
                                            <p className="text-xs text-rose-400 mt-1 ml-1 font-medium tracking-wide">è®°å½•æŸä¸€äº‹ä»¶çš„ä¸“å±è´¦å• âœ¨</p>
                                        </div>
                                        <button onClick={() => setShowAdd(true)} className="bg-gradient-to-r from-rose-400 to-pink-500 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-rose-200 active:scale-95 transition-all flex items-center gap-1.5 hover:shadow-rose-300">
                                            <Icon name="plus" size={18} strokeWidth={3}/> æ–°å»º
                                        </button>
                                    </div>
                
                                    {/* å¡ç‰‡ç½‘æ ¼ */}
                                    <div className="grid grid-cols-2 gap-4 overflow-y-auto pb-4 content-start relative z-10">
                                        {ledgers.filter(l => l.id !== 'default').map(l => {
                                            const count = transactions.filter(t => t.ledgerId === l.id).length;
                                            return (
                                                <button key={l.id} onClick={() => setSelectedId(l.id)} className="bg-white p-5 rounded-[1.5rem] shadow-sm border border-rose-100/50 hover:shadow-lg hover:shadow-rose-100 hover:-translate-y-1 transition-all text-left group relative overflow-hidden">
                                                    <div className={`absolute -right-5 -top-5 w-20 h-20 rounded-full opacity-10 ${l.color}`}></div>
                                                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-white mb-3 shadow-md ${l.color} group-hover:scale-110 transition-transform duration-300`}>
                                                        <Icon name={l.iconKey} size={24} />
                                                    </div>
                                                    <div className="relative z-10">
                                                        <div className="font-bold text-stone-800 text-lg mb-0.5 truncate">{l.name}</div>
                                                        <div className="text-xs text-stone-400 group-hover:text-rose-400 transition-colors flex items-center gap-1">
                                                            <Icon name="fileText" size={10} /> {count} ç¬”è®°å½•
                                                        </div>
                                                    </div>
                                                </button>
                                            )
                                        })}
                                        
                                        {ledgers.filter(l => l.id !== 'default').length === 0 && (
                                            <div className="col-span-2 text-center py-12 border-2 border-dashed border-rose-200 rounded-3xl bg-white/30">
                                                <div className="text-sm text-stone-400">è¿˜æ²¡åˆ›å»ºä¸“å±è´¦æœ¬</div>
                                                <div className="text-xs text-rose-400 mt-1">è¯•ç€å»ºä¸€ä¸ªâ€œæ—…æ¸¸â€æˆ–â€œè´­ç‰©â€çš„äº‹ä»¶è´¦æœ¬å§~</div>
                                            </div>
                                        )}
                                    </div>
                
                                    {/* æ·»åŠ è´¦æœ¬å¼¹çª— */}
                                    {showAdd && (
                                        <div className="fixed inset-0 bg-stone-900/40 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                                            <div className="bg-white rounded-3xl w-full max-w-xs p-6 shadow-2xl animate-slide-up border border-rose-100">
                                                <h3 className="font-bold text-lg mb-4 text-stone-800 flex items-center gap-2">
                                                    <Icon name="plus" className="text-rose-500" size={20}/> æ·»åŠ æ–°è´¦æœ¬
                                                </h3>
                                                
                                                <div className="flex gap-3 mb-5 overflow-x-auto no-scrollbar pb-2 px-1">
                                                    {presets.map(p => (
                                                        <button key={p.name} onClick={() => handleCreate(p.name, p)} className="flex-shrink-0 flex flex-col items-center gap-2 p-2 border border-stone-100 rounded-2xl min-w-[64px] hover:border-rose-200 hover:bg-rose-50 transition-colors">
                                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm ${p.color}`}>
                                                                <span className="scale-90"><Icon name={p.icon} size={20} /></span>
                                                            </div>
                                                            <span className="text-[10px] font-bold text-stone-600">{p.name}</span>
                                                        </button>
                                                    ))}
                                                </div>
                                                
                                                <div className="relative mb-6">
                                                    <input 
                                                        autoFocus 
                                                        placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰åç§°..." 
                                                        className="w-full bg-stone-50 p-4 rounded-2xl text-sm font-bold text-stone-700 outline-none border border-transparent focus:border-rose-300 focus:bg-white focus:ring-4 focus:ring-rose-100 transition-all placeholder-stone-300" 
                                                        value={newLedgerName} 
                                                        onChange={e => setNewLedgerName(e.target.value)} 
                                                    />
                                                    <div className="absolute right-4 top-4 text-stone-300">
                                                        <Icon name="edit2" size={16} />
                                                    </div>
                                                </div>
                
                                                <div className="flex gap-3">
                                                    <button onClick={() => setShowAdd(false)} className="flex-1 py-3 bg-stone-100 rounded-2xl text-sm font-bold text-stone-500 hover:bg-stone-200 transition-colors">å–æ¶ˆ</button>
                                                    <button onClick={() => handleCreate()} className="flex-1 py-3 bg-rose-500 rounded-2xl text-sm font-bold text-white shadow-lg shadow-rose-200 hover:bg-rose-600 active:scale-95 transition-all">åˆ›å»º</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        };

        const InfoView = ({ openConfirm, openAlert }) => {
                    const [backupModalOpen, setBackupModalOpen] = useState(false);
                    const [importModalOpen, setImportModalOpen] = useState(false);
                    const [dataString, setDataString] = useState('');
                    const [kissParticles, setKissParticles] = useState([]);
        
                    const [clearStep, setClearStep] = useState(0);
        
                    const handleTriggerKiss = () => {
                        const particles = Array.from({ length: 20 }).map((_, i) => ({
                            id: Date.now() + i,
                            char: ['ğŸ˜˜', 'ğŸ’‹', 'â¤ï¸', 'ğŸ’•',][Math.floor(Math.random() * 4)],
                            style: {
                                '--tx': `${(Math.random() - 0.5) * 300}px`, 
                                '--ty': `${(Math.random() - 0.5) * 300}px`,
                                '--r': `${Math.random() * 360}deg`,
                                fontSize: `${Math.random() * 20 + 40}px`
                            }
                        }));
                        setKissParticles(particles);
                        setTimeout(() => { setKissParticles([]); }, 1000);
                    };
        
                    const handleSummon = () => {
                        const tempInput = document.createElement('input');
                        tempInput.value = "hqsngj158"; 
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        openAlert("å¬å”¤æˆåŠŸ", "é©¬ä¸Šå¸®ä½ æ‰“å¼€å¾®ä¿¡ï¼Œå¿«æ¥æ‰¾æˆ‘å§ï¼â¤ï¸");
                        setTimeout(() => { window.location.href = "weixin://"; }, 500);
                    };
        
                    const handleExport = () => {
                        const data = {
                            transactions: localStorage.getItem('qs_transactions'),
                            accounts: localStorage.getItem('qs_accounts'),
                            categories: localStorage.getItem('qs_categories'),
                            ledgers: localStorage.getItem('qs_ledgers'),
                            templates: localStorage.getItem('qs_templates')
                        };
                        setDataString(JSON.stringify(data));
                        setBackupModalOpen(true);
                    };
        
                    const handleImport = () => {
                        if (!dataString) return;
                        try {
                            const data = JSON.parse(dataString);
                            // ä¿®æ”¹ï¼šä½¿ç”¨ openConfirm æ›¿ä»£åŸç”Ÿ confirm
                            openConfirm("é«˜èƒ½é¢„è­¦", "æ¢å¤æ•°æ®ä¼šè¦†ç›–å½“å‰æ‰‹æœºé‡Œçš„æ‰€æœ‰è®°å½•ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ", () => {
                                if(data.transactions) localStorage.setItem('qs_transactions', data.transactions);
                                if(data.accounts) localStorage.setItem('qs_accounts', data.accounts);
                                if(data.categories) localStorage.setItem('qs_categories', data.categories);
                                if(data.ledgers) localStorage.setItem('qs_ledgers', data.ledgers);
                                if(data.templates) localStorage.setItem('qs_templates', data.templates);
                                openAlert("æˆåŠŸ", "æ•°æ®æ¢å¤æˆåŠŸï¼æ­£åœ¨åˆ·æ–°...");
                                setTimeout(() => window.location.reload(), 1000);
                            }, 'delete', 'ç¡®è®¤è¦†ç›–');
                        } catch (e) { openAlert("é”™è¯¯", "æ•°æ®æ ¼å¼ä¸å¯¹å“¦ï¼Œè¯·å¤åˆ¶å®Œæ•´çš„å¤‡ä»½æš—å·ï¼"); }
                    };
        
                    const copyToClipboard = () => {
                        const el = document.getElementById('backup-textarea');
                        el.select();
                        document.execCommand('copy');
                        openAlert("æˆåŠŸ", "å·²å¤åˆ¶ï¼å¿«å‘ç»™æˆ‘ä¿ç®¡å§~");
                    };
        
                    const executeClear = () => {
                        localStorage.removeItem('qs_transactions');
                        localStorage.removeItem('qs_accounts');
                        localStorage.removeItem('qs_categories');
                        localStorage.removeItem('qs_ledgers');
                        localStorage.removeItem('qs_templates');
                        
                        openAlert("é‡ç½®å®Œæˆ", "æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼Œä¸€åˆ‡ä»æ–°å¼€å§‹~ âœ¨");
                        setTimeout(() => window.location.reload(), 1500);
                    };
        
                    // ç»Ÿä¸€çš„å¼¹çª—å®¹å™¨æ ·å¼ç±»
                    const modalBaseClass = "fixed inset-0 bg-stone-900/40 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in";
                    const modalContentClass = "bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl border border-rose-100 animate-slide-up relative overflow-hidden";
                    const bgDeco = <div className="absolute top-0 right-0 w-24 h-24 bg-rose-100 rounded-full blur-2xl -mr-10 -mt-10 opacity-50 pointer-events-none"></div>;
        
                    return (
                        <div className="h-full overflow-y-auto p-6 pt-12 pb-24 bg-[#fff1f2] animate-fade-in relative">
                            {kissParticles.map(p => (<div key={p.id} className="animate-explode" style={p.style}>{p.char}</div>))}
        
                            <div className="flex flex-col items-center gap-4 mb-10">
                                <div className="relative">
                                    <div className="absolute inset-0 bg-rose-300 blur-xl opacity-30 rounded-full animate-pulse"></div>
                                    <img src="./logo.png" alt="Logo" className="w-24 h-24 rounded-[2rem] shadow-2xl shadow-rose-200 border-4 border-white relative z-10 hover:scale-105 transition-transform duration-500" />
                                    <div onClick={handleTriggerKiss} className="absolute -right-2 -top-2 bg-white rounded-full p-1.5 shadow-md z-20 animate-bounce cursor-pointer hover:scale-110 active:scale-90 transition-transform">
                                        <Icon name="heart" size={16} className="text-rose-500 fill-rose-500" />
                                    </div>
                                </div>
                                <div className="text-center">
                                    <h1 className="text-2xl font-bold text-stone-800 font-serif mb-1 tracking-wide">é’æ¾è®°è´¦</h1>
                                    <div className="inline-block bg-gradient-to-r from-rose-100 to-pink-100 text-rose-500 text-xs font-bold px-3 py-1 rounded-full border border-rose-200">Girlfriend Edition v5.20</div>
                                </div>
                            </div>
        
                            <div className="mb-8">
                                <h3 className="font-bold text-stone-700 flex items-center gap-2 mb-4 ml-2">
                                    <div className="bg-rose-100 p-1.5 rounded-lg text-rose-500"><Icon name="sparkles" size={16}/></div> è´´å¿ƒåŠŸèƒ½
                                </h3>
                                <div className="bg-white/80 backdrop-blur-sm p-5 rounded-[2rem] border border-rose-100 shadow-sm space-y-6">
                                    <div className="flex gap-4 group"><div className="mt-1 bg-amber-100 text-amber-500 p-2.5 rounded-2xl h-fit shadow-sm group-hover:scale-110 transition-transform"><Icon name="zap" size={18}/></div><div><div className="font-bold text-stone-700 text-sm">æç®€è®°è´¦</div><p className="text-xs text-stone-400 mt-1 leading-relaxed">å°±åƒå–æ°´ä¸€æ ·ç®€å•ï¼Œæ²¡æœ‰å¤šä½™æ­¥éª¤ï¼Œä¸“é—¨ä¸ºä½ è®¾è®¡çš„æ¸…çˆ½ç•Œé¢ã€‚</p></div></div>
                                    <div className="flex gap-4 group"><div className="mt-1 bg-blue-100 text-blue-500 p-2.5 rounded-2xl h-fit shadow-sm group-hover:scale-110 transition-transform"><Icon name="wallet" size={18}/></div><div><div className="font-bold text-stone-700 text-sm">å°é‡‘åº“ç®¡ç†</div><p className="text-xs text-stone-400 mt-1 leading-relaxed">å¸®ä½ ç®¡å¥½å¾®ä¿¡ã€æ”¯ä»˜å®å’Œé“¶è¡Œå¡é‡Œçš„é’±ï¼Œæ”’é’±ä¹°æƒ³è¦çš„ä¸œè¥¿ï¼</p></div></div>
                                    <div className="flex gap-4 group"><div className="mt-1 bg-rose-100 text-rose-500 p-2.5 rounded-2xl h-fit shadow-sm group-hover:scale-110 transition-transform"><Icon name="book" size={18}/></div><div><div className="font-bold text-stone-700 text-sm">ä¸“å±è´¦æœ¬</div><p className="text-xs text-stone-400 mt-1 leading-relaxed">æ—…æ¸¸ã€è´­ç½®ã€å…»å® ç‰©... ä¸ºæ¯ä¸€ä¸ªç‰¹åˆ«çš„åœºæ™¯å»ºç«‹ä¸“å±çš„å°è´¦æœ¬ã€‚</p></div></div>
                                    <div className="flex gap-4 group"><div className="mt-1 bg-emerald-100 text-emerald-500 p-2.5 rounded-2xl h-fit shadow-sm group-hover:scale-110 transition-transform"><Icon name="shieldCheck" size={18}/></div><div><div className="font-bold text-stone-700 text-sm">ç»å¯¹å®‰å…¨</div><p className="text-xs text-stone-400 mt-1 leading-relaxed">æ•°æ®ä¹–ä¹–èººåœ¨ä½ çš„æ‰‹æœºé‡Œï¼Œä¸ä¸Šä¼ ç½‘ç»œï¼Œåªæœ‰ä½ èƒ½çœ‹åˆ°ã€‚</p></div></div>
                                </div>
                            </div>
                            
                            <div className="mb-8">
                                <h3 className="font-bold text-stone-700 flex items-center gap-2 mb-4 ml-2">
                                    <div className="bg-rose-100 p-1.5 rounded-lg text-rose-500"><Icon name="message" size={16}/></div> å¬å”¤ç”·æœ‹å‹
                                </h3>
                                <div className="bg-gradient-to-br from-white to-rose-50 p-6 rounded-[2rem] border border-rose-100 shadow-sm flex flex-col items-center text-center relative overflow-hidden">
                                    <div className="absolute -right-6 -top-6 w-20 h-20 bg-rose-100 rounded-full blur-xl"></div>
                                    <p className="text-sm text-stone-600 mb-6 font-medium relative z-10 leading-relaxed">è½¯ä»¶æœ‰ä»»ä½•ä¸å¥½ç”¨çš„åœ°æ–¹ï¼Œæˆ–è€…æƒ³è¦æ–°åŠŸèƒ½ï¼Œ<br/>éšæ—¶å‘¼å«æˆ‘å“¦ â¤ï¸</p>
                                    <button onClick={handleSummon} className="relative z-10 bg-gradient-to-r from-rose-400 to-pink-500 text-white font-bold py-3 px-8 rounded-2xl shadow-lg shadow-rose-200 active:scale-95 transition-all flex items-center gap-2 hover:shadow-rose-300">
                                        <Icon name="heart" className="animate-pulse" size={18} /> ä¸€é”®å¬å”¤ç”·æœ‹å‹
                                    </button>
                                </div>
                            </div>
        
                            <div className="mb-8">
                                 <h3 className="font-bold text-stone-700 flex items-center gap-2 mb-4 ml-2">
                                    <div className="bg-rose-100 p-1.5 rounded-lg text-rose-500"><Icon name="save" size={16}/></div> æ•°æ®ç®¡ç†
                                 </h3>
                                 <div className="bg-white p-5 rounded-[2rem] border border-rose-100 shadow-sm space-y-3">
                                     <div className="flex gap-3">
                                         <button onClick={handleExport} className="flex-1 bg-rose-50 text-rose-500 py-3.5 rounded-2xl font-bold text-sm border border-rose-100 active:scale-95 transition-all hover:bg-rose-100 flex items-center justify-center gap-2"><Icon name="save" size={16}/> å¯¼å‡ºå¤‡ä»½</button>
                                         <button onClick={() => { setDataString(''); setImportModalOpen(true); }} className="flex-1 bg-blue-50 text-blue-500 py-3.5 rounded-2xl font-bold text-sm border border-blue-100 active:scale-95 transition-all hover:bg-blue-100 flex items-center justify-center gap-2"><Icon name="fileText" size={16}/> å¯¼å…¥æ¢å¤</button>
                                     </div>
                                     <button onClick={() => setClearStep(1)} className="w-full py-3.5 rounded-2xl border border-red-100 text-red-400 bg-red-50/50 text-sm font-bold active:bg-red-100 active:scale-95 transition-all flex items-center justify-center gap-2 hover:bg-red-50 hover:text-red-500">
                                        <Icon name="trash2" size={16} /> é‡ç½®æ‰€æœ‰æ•°æ®
                                     </button>
                                     <p className="text-[10px] text-stone-400 text-center leading-relaxed">æ¢æ‰‹æœºè®°å¾—å¤‡ä»½å“¦~ å¦‚æœæ•°æ®ä¹±äº†å¯ä»¥ç‚¹é‡ç½®ã€‚</p>
                                 </div>
                            </div>
        
                            <div className="mt-12 text-center pb-4">
                                <div className="text-[10px] text-rose-300 mb-2 font-medium">Made with Love for You</div>
                                <div className="flex justify-center gap-1.5">
                                    <div className="w-1.5 h-1.5 bg-rose-300 rounded-full animate-bounce" style={{animationDelay: '0s'}}></div>
                                    <div className="w-1.5 h-1.5 bg-rose-300 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                    <div className="w-1.5 h-1.5 bg-rose-300 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div>
                                </div>
                            </div>
        
                            {/* --- å¼¹çª—åŒºåŸŸï¼šç»Ÿä¸€é£æ ¼ --- */}
                            
                             {backupModalOpen && (
                                <div className={modalBaseClass}>
                                    <div className={modalContentClass}>
                                        {bgDeco}
                                        <h3 className="font-bold text-lg mb-3 text-stone-800 flex items-center gap-2 relative z-10"><Icon name="save" className="text-rose-400"/> å¤‡ä»½æš—å·</h3>
                                        <p className="text-xs text-stone-500 mb-4 relative z-10">å…¨é€‰å¤åˆ¶ä¸‹é¢çš„ä¹±ç ï¼Œä¿å­˜æˆ–è€…å‘ç»™æˆ‘å°±è¡Œå•¦ã€‚</p>
                                        <textarea id="backup-textarea" readOnly value={dataString} className="w-full h-32 bg-stone-50 border border-transparent focus:border-rose-300 focus:bg-white text-[10px] text-stone-500 p-3 rounded-2xl mb-6 break-all outline-none transition-all relative z-10"></textarea>
                                        <div className="flex gap-3 relative z-10">
                                            <button onClick={() => setBackupModalOpen(false)} className="flex-1 py-3 bg-stone-50 text-stone-500 font-bold rounded-2xl text-sm hover:bg-stone-100">å…³é—­</button>
                                            <button onClick={copyToClipboard} className="flex-1 py-3 bg-gradient-to-r from-rose-400 to-pink-500 text-white font-bold rounded-2xl text-sm shadow-lg shadow-rose-200">å¤åˆ¶</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                             {importModalOpen && (
                                <div className={modalBaseClass}>
                                    <div className={modalContentClass}>
                                        {bgDeco}
                                        <h3 className="font-bold text-lg mb-3 text-stone-800 flex items-center gap-2 relative z-10"><Icon name="fileText" className="text-rose-400"/> æ¢å¤æ•°æ®</h3>
                                        <p className="text-xs text-stone-500 mb-4 relative z-10">æŠŠå¤‡ä»½çš„æš—å·ç²˜è´´åˆ°ä¸‹é¢ï¼š</p>
                                        <textarea placeholder="ç²˜è´´å¤‡ä»½ä»£ç ..." value={dataString} onChange={(e) => setDataString(e.target.value)} className="w-full h-32 bg-stone-50 border border-transparent focus:border-rose-300 focus:bg-white text-[10px] text-stone-600 p-3 rounded-2xl mb-6 break-all outline-none transition-all relative z-10"></textarea>
                                        <div className="flex gap-3 relative z-10">
                                            <button onClick={() => setImportModalOpen(false)} className="flex-1 py-3 bg-stone-50 text-stone-500 font-bold rounded-2xl text-sm hover:bg-stone-100">å–æ¶ˆ</button>
                                            <button onClick={handleImport} className="flex-1 py-3 bg-gradient-to-r from-rose-400 to-pink-500 text-white font-bold rounded-2xl text-sm shadow-lg shadow-rose-200">æ¢å¤</button>
                                        </div>
                                    </div>
                                </div>
                            )}
        
                            {clearStep === 1 && (
                                <div className={modalBaseClass}>
                                    <div className={modalContentClass}>
                                        {bgDeco}
                                        <h3 className="font-bold text-lg mb-3 text-stone-800 flex items-center gap-2 relative z-10"><Icon name="info" className="text-red-400"/> âš ï¸ å°å¿ƒæ“ä½œ</h3>
                                        <p className="text-sm text-stone-600 mb-6 leading-relaxed relative z-10">çœŸçš„è¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ<br/>è®°è¿‡çš„è´¦å•ã€è´¦æˆ·ã€æ¨¡æ¿éƒ½ä¼šæ¶ˆå¤±ï¼Œä¸”<strong className="text-red-500">æ— æ³•æ¢å¤</strong>å“¦ï¼</p>
                                        <div className="flex gap-3 relative z-10">
                                            <button onClick={() => setClearStep(0)} className="flex-1 py-3 bg-stone-50 text-stone-500 font-bold rounded-2xl text-sm hover:bg-stone-100">ç‚¹é”™äº†</button>
                                            <button onClick={() => setClearStep(2)} className="flex-1 py-3 bg-red-400 text-white font-bold rounded-2xl text-sm shadow-lg shadow-red-200">ç»§ç»­æ¸…é™¤</button>
                                        </div>
                                    </div>
                                </div>
                            )}
        
                            {clearStep === 2 && (
                                <div className={modalBaseClass}>
                                    <div className={modalContentClass}>
                                        {bgDeco}
                                        <h3 className="font-bold text-lg mb-3 text-stone-800 flex items-center gap-2 relative z-10"><Icon name="trash2" className="text-red-400"/> ğŸ”´ æœ€ç»ˆç¡®è®¤</h3>
                                        <p className="text-sm text-stone-600 mb-6 leading-relaxed relative z-10">ç¡®å®šè¦è®© App å˜å›åˆšå®‰è£…çš„æ ·å­å—ï¼Ÿ</p>
                                        <div className="flex gap-3 relative z-10">
                                            <button onClick={() => setClearStep(0)} className="flex-1 py-3 bg-stone-50 text-stone-500 font-bold rounded-2xl text-sm hover:bg-stone-100">æˆ‘åæ‚”äº†</button>
                                            <button onClick={executeClear} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-2xl text-sm shadow-lg shadow-red-200">ç¡®è®¤é‡ç½®</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                };

        const StatsView = ({ accounts, transactions, categories }) => {
                    const [timeRange, setTimeRange] = useState('month'); 
                    const [flowType, setFlowType] = useState('expense'); 
                    
                    const getAccountBalance = (accountId) => {
                        const account = accounts.find(a => a.id === accountId); if (!account) return 0;
                        let balance = Number(account.initialBalance || 0);
                        const relatedTrans = transactions.filter(t => t.accountId === accountId || t.sourceId === accountId || t.targetId === accountId);
                        relatedTrans.forEach(t => {
                           if (t.type === 'expense') { if (account.group === 'asset') balance -= Number(t.amount); else balance += Number(t.amount); }
                           else if (t.type === 'income') { if (account.group === 'asset') balance += Number(t.amount); else balance -= Number(t.amount); }
                           else if (t.type === 'transfer') {
                               if (t.sourceId === accountId) { if (account.group === 'asset') balance -= Number(t.amount); else balance += Number(t.amount); }
                               else if (t.targetId === accountId) { if (account.group === 'asset') balance += Number(t.amount); else balance -= Number(t.amount); }
                           }
                        });
                        return balance;
                    };
        
                    const assetData = useMemo(() => accounts.filter(acc => acc.group === 'asset').map((acc, index) => ({ name: acc.name, value: getAccountBalance(acc.id), color: PIE_COLORS[index % PIE_COLORS.length] })).filter(item => item.value > 0).sort((a,b) => b.value - a.value), [accounts, transactions]);
                    
                    const flowData = useMemo(() => {
                        const now = new Date();
                        const filtered = transactions.filter(t => {
                            if(t.type === 'transfer') return false; 
                            const d = new Date(t.date);
                            if (t.type !== flowType) return false;
                            if (timeRange === 'day') return d.toDateString() === now.toDateString();
                            if (timeRange === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                            if (timeRange === 'year') return d.getFullYear() === now.getFullYear();
                            return true;
                        });
                        const grouped = {};
                        const catList = flowType === 'expense' ? categories.expense : categories.income;
                        
                        filtered.forEach(t => { 
                            const catObj = catList.find(c => c.id === t.category);
                            const catName = catObj?.name || 'æœªçŸ¥'; 
                            if (!grouped[catName]) {
                                grouped[catName] = { value: 0, iconKey: catObj?.iconKey || 'more', color: catObj?.color || 'bg-gray-200' };
                            }
                            grouped[catName].value += Number(t.amount);
                        });
                        
                        return Object.entries(grouped)
                            .map(([name, data], idx) => ({ 
                                name, 
                                value: data.value, 
                                iconKey: data.iconKey, 
                                color: PIE_COLORS[idx % PIE_COLORS.length], 
                                catColor: data.color 
                            }))
                            .sort((a, b) => b.value - a.value);
                    }, [transactions, timeRange, flowType, categories]);
        
                    const totalFlow = flowData.reduce((acc, item) => acc + item.value, 0);
        
                    return (
                        <div className="pt-10 px-5 h-full overflow-y-auto pb-24 animate-fade-in bg-[#fff1f2]"> {/* ç»Ÿä¸€ç²‰è‰²èƒŒæ™¯ */}
                            <h2 className="text-2xl font-bold text-stone-800 mb-6 flex items-center gap-2">
                                {/* æ ‡é¢˜å›¾æ ‡æ”¹ä¸ºç²‰è‰² */}
                                <Icon name="pieChart" className="text-rose-500" /> 
                                è´¢åŠ¡åˆ†æ
                            </h2>
                            
                            {/* èµ„äº§åˆ†å¸ƒå¡ç‰‡ */}
                            <div className="bg-white rounded-[1.5rem] p-6 shadow-sm border border-rose-100 mb-6 relative overflow-hidden">
                                {/* è£…é¥°æ€§èƒŒæ™¯è§’æ ‡ */}
                                <div className="absolute top-0 right-0 w-16 h-16 bg-rose-50 rounded-bl-full -mr-4 -mt-4 opacity-50 pointer-events-none"></div>
        
                                <h3 className="text-sm font-bold text-stone-400 uppercase tracking-wider mb-4 flex items-center gap-2 relative z-10">
                                    <Icon name="wallet" size={14} className="text-rose-400"/> èµ„äº§åˆ†å¸ƒ
                                </h3>
                                <PieChartComponent data={assetData} emptyMessage="èµ„äº§ç©ºç©ºå¦‚ä¹Ÿ" />
                            </div>
        
                            {/* æ”¶æ”¯ç»“æ„ä¸æ’è¡Œæ¦œå¡ç‰‡ */}
                            <div className="bg-white rounded-[1.5rem] p-6 shadow-sm border border-rose-100 mb-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-sm font-bold text-stone-400 uppercase tracking-wider flex items-center gap-2">
                                        <Icon name="filter" size={14} className="text-rose-400"/> æ”¶æ”¯åˆ†æ
                                    </h3>
                                    {/* æ”¶æ”¯åˆ‡æ¢ï¼šç²‰è‰²é£æ ¼ */}
                                    <div className="flex bg-rose-50 rounded-xl p-1">
                                        <button onClick={() => setFlowType('expense')} className={`px-4 py-1.5 text-xs rounded-lg transition-all font-bold ${flowType === 'expense' ? 'bg-white shadow-sm text-rose-500' : 'text-stone-400 hover:text-rose-300'}`}>æ”¯å‡º</button>
                                        <button onClick={() => setFlowType('income')} className={`px-4 py-1.5 text-xs rounded-lg transition-all font-bold ${flowType === 'income' ? 'bg-white shadow-sm text-rose-500' : 'text-stone-400 hover:text-rose-300'}`}>æ”¶å…¥</button>
                                    </div>
                                </div>
                                
                                {/* æ—¶é—´åˆ‡æ¢ï¼šæ”¹ä¸ºç²‰è‰²è¾¹æ¡† */}
                                <div className="flex gap-2 mb-8">
                                    {['day', 'month', 'year'].map(r => (
                                        <button key={r} onClick={() => setTimeRange(r)} className={`flex-1 py-2 text-xs font-bold rounded-xl border transition-all ${timeRange === r ? 'bg-rose-50 border-rose-300 text-rose-500 shadow-sm shadow-rose-100' : 'bg-transparent border-stone-100 text-stone-400 hover:border-rose-200 hover:bg-white'}`}>
                                            {r === 'day' ? 'ä»Šæ—¥' : (r === 'month' ? 'æœ¬æœˆ' : 'ä»Šå¹´')}
                                        </button>
                                    ))}
                                </div>
                                
                                {/* é¥¼å›¾ */}
                                <div className="mb-8 border-b border-rose-50 pb-8">
                                    <PieChartComponent data={flowData} emptyMessage="è¯¥æ—¶æ®µæ— è®°å½•" />
                                </div>
        
                                {/* æ’è¡Œæ¦œæ¿å— */}
                                <div>
                                    <h4 className="text-sm font-bold text-stone-800 mb-4 flex items-center gap-2">
                                        <Icon name="list" size={16} className="text-rose-500"/> 
                                        {flowType === 'expense' ? 'æ”¯å‡ºæ’è¡Œæ¦œ' : 'æ”¶å…¥æ’è¡Œæ¦œ'}
                                    </h4>
                                    <div className="space-y-4">
                                        {flowData.length === 0 ? (
                                            <div className="text-center text-xs text-rose-300 py-4 opacity-70">
                                                <Icon name="sparkles" size={24} className="mx-auto mb-1"/>
                                                æš‚æ— æ•°æ®
                                            </div>
                                        ) : (
                                            flowData.map((item, index) => (
                                                <div key={index} className="flex items-center justify-between group">
                                                    <div className="flex items-center gap-3 flex-1">
                                                        {/* æ’ååºå·ï¼šç«ç‘°é‡‘è‰² */}
                                                        <div className="w-6 text-xs font-bold text-rose-300 italic">#{index + 1}</div>
                                                        
                                                        {/* å›¾æ ‡ï¼šå¸¦ä¸€ç‚¹é˜´å½± */}
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center scale-90 shadow-sm ${item.catColor}`}>
                                                            <Icon name={item.iconKey} size={16} />
                                                        </div>
                                                        
                                                        {/* è¿›åº¦æ¡ä¸åç§° */}
                                                        <div className="flex-1 mr-4">
                                                            <div className="flex justify-between items-end mb-1">
                                                                <span className="text-xs font-bold text-stone-700">{item.name}</span>
                                                                <span className="text-[10px] text-stone-400 font-mono">{((item.value / totalFlow) * 100).toFixed(1)}%</span>
                                                            </div>
                                                            {/* è¿›åº¦æ¡åº•è‰²æ”¹ä¸ºææ·¡ç²‰ */}
                                                            <div className="h-1.5 w-full bg-rose-50 rounded-full overflow-hidden">
                                                                <div className="h-full rounded-full transition-all duration-500" style={{ width: `${(item.value / flowData[0].value) * 100}%`, backgroundColor: item.color }}></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="text-sm font-bold font-mono text-stone-700">
                                                        Â¥{item.value.toLocaleString()}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                };

        const AssetManagementView = ({ onClose, netWorth, accounts, getAccountBalance, onAddAccountClick, onTransferClick, onDeleteAccount, onUpdateAccount }) => {
            const assetAccounts = accounts.filter(a => a.group === 'asset');
            const liabilityAccounts = accounts.filter(a => a.group === 'liability');
            
            return (
                // èƒŒæ™¯è‰²æ”¹ä¸ºæ·¡ç²‰è‰² bg-[#fff1f2]
                <div className="absolute inset-0 z-50 bg-[#fff1f2] flex flex-col animate-fade-in">
                    
                    {/* å¤´éƒ¨ï¼šæ”¹ä¸ºç²‰è‰²æ¸å˜ + ç²‰è‰²é˜´å½± */}
                    <div className="bg-gradient-to-br from-rose-400 to-pink-500 text-white p-6 pt-12 rounded-b-[2.5rem] shadow-xl shadow-pink-200">
                        <div className="flex justify-between items-center mb-6">
                            <button onClick={onClose} className="bg-white/20 p-2 rounded-full hover:bg-white/30 transition-all">
                                <Icon name="chevronLeft" strokeWidth={3} />
                            </button>
                            <span className="font-bold text-lg tracking-wider">èµ„äº§å°ç®¡å®¶</span>
                            <div className="w-8"></div> {/* å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ */}
                        </div>
                        <div className="text-center">
                            <div className="text-pink-100 text-xs mb-2 font-medium bg-white/10 inline-block px-3 py-1 rounded-full">
                                å‡€èµ„äº§ (èµ„äº§ - è´Ÿå€º)
                            </div>
                            <div className="text-4xl font-bold font-mono drop-shadow-sm">Â¥ {netWorth.toLocaleString()}</div>
                        </div>
                    </div>

                    {/* åˆ—è¡¨åŒºåŸŸ */}
                    <div className="flex-1 overflow-y-auto p-5 space-y-6 pb-24">
                        
                        {/* èµ„äº§è´¦æˆ·ç»„ */}
                        <div>
                            <h3 className="text-rose-500 font-bold mb-3 flex items-center gap-2 text-sm ml-1">
                                <Icon name="wallet" size={16}/> æˆ‘çš„å°é‡‘åº“
                            </h3>
                            <div className="space-y-3">
                                {assetAccounts.map(acc => (
                                    <div key={acc.id} className="bg-white p-4 rounded-2xl shadow-sm border border-rose-100/50 hover:shadow-md transition-all">
                                        <div className="flex justify-between items-center mb-3">
                                            <div className="flex items-center gap-3">
                                                {/* å›¾æ ‡èƒŒæ™¯ */}
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm ${acc.color}`}>
                                                    <Icon name={acc.iconKey} size={20} />
                                                </div>
                                                <div>
                                                    {/* è´¦æˆ·åè¾“å…¥æ¡†ï¼šç„¦ç‚¹æ”¹ä¸ºç²‰è‰² */}
                                                    <input 
                                                        className="font-bold text-stone-700 bg-transparent focus:bg-stone-50 rounded px-1 outline-none w-32 border-b border-transparent focus:border-rose-400 transition-colors" 
                                                        value={acc.name} 
                                                        onChange={(e) => onUpdateAccount(acc.id, 'name', e.target.value)} 
                                                    />
                                                    <div className="text-xs text-stone-400 mt-1 flex items-center">
                                                        åˆå§‹: Â¥
                                                        <input 
                                                            type="number" 
                                                            className="w-24 bg-transparent border-b border-stone-100 focus:border-rose-400 outline-none ml-1 text-stone-500 font-mono" 
                                                            value={acc.initialBalance} 
                                                            onChange={(e) => onUpdateAccount(acc.id, 'initialBalance', e.target.value)} 
                                                            placeholder="0" 
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                {/* é‡‘é¢é¢œè‰²ï¼šæ”¹ä¸ºç²‰è‰² */}
                                                <div className="font-bold text-lg text-rose-500 font-mono">
                                                    Â¥ {getAccountBalance(acc.id).toLocaleString()}
                                                </div>
                                                <div className="flex justify-end items-center gap-2 mt-1">
                                                    {acc.isLiquid && (
                                                        <span className="text-[10px] bg-rose-100 text-rose-500 px-2 py-0.5 rounded-lg font-bold">æµåŠ¨</span>
                                                    )}
                                                    <button onClick={() => onDeleteAccount(acc.id)} className="text-xs text-rose-300 hover:text-red-500 flex items-center justify-end gap-1 bg-rose-50 px-2 py-1 rounded-lg transition-colors">
                                                        <Icon name="trash2" size={12} />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* è´Ÿå€ºè´¦æˆ·ç»„ */}
                        <div>
                            <h3 className="text-stone-400 font-bold mb-3 flex items-center gap-2 text-sm ml-1">
                                <Icon name="debt" size={16}/> è´Ÿå€º (è¦è¿˜çš„é’±)
                            </h3>
                            <div className="space-y-3">
                                {liabilityAccounts.map(acc => (
                                    <div key={acc.id} className="bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                                        <div className="flex justify-between items-center mb-3">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white ${acc.color}`}>
                                                    <Icon name={acc.iconKey} size={20} />
                                                </div>
                                                <div>
                                                    <input 
                                                        className="font-bold text-stone-700 bg-transparent focus:bg-stone-50 rounded px-1 outline-none w-32 border-b border-transparent focus:border-stone-400 transition-colors" 
                                                        value={acc.name} 
                                                        onChange={(e) => onUpdateAccount(acc.id, 'name', e.target.value)} 
                                                    />
                                                    <div className="text-xs text-stone-400 mt-1 flex items-center">
                                                        åˆå§‹æ¬ æ¬¾: Â¥
                                                        <input 
                                                            type="number" 
                                                            className="w-20 bg-transparent border-b border-stone-100 focus:border-stone-400 outline-none ml-1 text-stone-500 font-mono" 
                                                            value={acc.initialBalance} 
                                                            onChange={(e) => onUpdateAccount(acc.id, 'initialBalance', e.target.value)} 
                                                            placeholder="0" 
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                {/* è´Ÿå€ºé‡‘é¢ä¿æŒçº¢è‰²ï¼Œèµ·åˆ°è­¦ç¤ºä½œç”¨ */}
                                                <div className="font-bold text-lg text-stone-600 font-mono">
                                                    Â¥ {getAccountBalance(acc.id).toLocaleString()}
                                                </div>
                                                <button onClick={() => onDeleteAccount(acc.id)} className="text-xs text-stone-400 hover:text-red-500 mt-1 flex items-center justify-end gap-1 ml-auto bg-stone-100 px-2 py-1 rounded-lg transition-colors">
                                                    <Icon name="trash2" size={12} /> åˆ é™¤
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* åº•éƒ¨æŒ‰é’®æ  */}
                    <div className="p-4 bg-white/80 backdrop-blur-md border-t border-rose-100 flex gap-3 pb-8 safe-area-bottom">
                        <button onClick={onAddAccountClick} className="flex-1 py-3.5 rounded-2xl bg-rose-100 text-rose-600 font-bold flex items-center justify-center gap-2 active:scale-95 transition-all shadow-sm">
                            <Icon name="plus" size={18} strokeWidth={3}/> æ·»åŠ è´¦æˆ·
                        </button>
                        <button onClick={onTransferClick} className="flex-1 py-3.5 rounded-2xl bg-sky-100 text-sky-600 font-bold flex items-center justify-center gap-2 active:scale-95 transition-all shadow-sm">
                            <Icon name="transfer" size={18} strokeWidth={2.5}/> è´¦æˆ·è½¬è´¦
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
                    const [activeTab, setActiveTab] = useState('home'); 
                    const [showManageAssets, setShowManageAssets] = useState(false);
                    const [transactions, setTransactions] = useState([]);
                    const [accounts, setAccounts] = useState(DEFAULT_ACCOUNTS);
                    const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
                    const [ledgers, setLedgers] = useState([{ id: 'default', name: 'æ—¥å¸¸è´¦æœ¬', type: 'daily', iconKey: 'home', color: 'bg-emerald-600' }]);
                    const [editingTransaction, setEditingTransaction] = useState(null);
                    const [modalConfig, setModalConfig] = useState({ isOpen: false, type: 'confirm', title: '', content: '' });
                    const [modalInputVal, setModalInputVal] = useState('');
                    const [modalCallback, setModalCallback] = useState(null);
                    const [transferModalOpen, setTransferModalOpen] = useState(false);
                    const [transferData, setTransferData] = useState({ sourceId: '', targetId: '', amount: '' });
                    const [addAccountModalOpen, setAddAccountModalOpen] = useState(false);
                    const [newAccountData, setNewAccountData] = useState({ name: '', type: 'asset', initial: '', isLiquid: true, iconKey: 'wallet' });
                    const [templates, setTemplates] = useState([]); 
                    
                    // --- æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ æ•°æ®åŠ è½½å®Œæˆçš„æ ‡è®° ---
                    const [isLoaded, setIsLoaded] = useState(false);
        
                    // 1. è¯»å–æ•°æ®çš„ Effect (åªåœ¨å¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡)
                    useEffect(() => {
                        const savedTrans = localStorage.getItem('qs_transactions');
                        const savedAccs = localStorage.getItem('qs_accounts'); 
                        const savedCats = localStorage.getItem('qs_categories'); 
                        const savedLedgers = localStorage.getItem('qs_ledgers');
                        const savedTemplates = localStorage.getItem('qs_templates');
        
                        if (savedTrans) setTransactions(JSON.parse(savedTrans)); 
                        if (savedAccs) setAccounts(JSON.parse(savedAccs)); 
                        if (savedLedgers) setLedgers(JSON.parse(savedLedgers));
                        if (savedTemplates) setTemplates(JSON.parse(savedTemplates));
                        
                        // æ™ºèƒ½åˆå¹¶åˆ†ç±»é€»è¾‘
                        if (savedCats) {
                            const parsedCats = JSON.parse(savedCats);
                            const hasHygiene = parsedCats.expense.some(c => c.id === 'hygiene');
                            if (!hasHygiene) {
                                const newHygieneCat = DEFAULT_CATEGORIES.expense.find(c => c.id === 'hygiene');
                                if (newHygieneCat) {
                                    parsedCats.expense.splice(4, 0, newHygieneCat); 
                                    setCategories(parsedCats); 
                                } else {
                                    parsedCats.expense.push({ id: 'hygiene', name: 'å«ç”Ÿ', iconKey: 'sanitary', color: 'bg-rose-100 text-rose-700' });
                                    setCategories(parsedCats);
                                }
                            } else {
                                setCategories(parsedCats);
                            }
                        } else {
                            setCategories(DEFAULT_CATEGORIES);
                        }
        
                        // --- å…³é”®ï¼šæ ‡è®°æ•°æ®å·²åŠ è½½å®Œæˆ ---
                        // åªæœ‰è¿™é‡Œæ‰§è¡Œåï¼ŒisLoaded å˜ä¸º trueï¼Œä¸‹é¢çš„ä¿å­˜é€»è¾‘æ‰ä¼šç”Ÿæ•ˆ
                        setIsLoaded(true); 
        
                    }, []);
        
                    // 2. ä¿å­˜æ•°æ®çš„ Effect (åªæœ‰å½“ isLoaded ä¸º true æ—¶æ‰æ‰§è¡Œä¿å­˜)
                    // è¿™æ ·å°±é˜²æ­¢äº†åˆå§‹çš„ç©ºæ•°ç»„ [] è¦†ç›–æ‰æœ¬åœ°å·²æœ‰çš„æ•°æ®
                    useEffect(() => { 
                        if (isLoaded) localStorage.setItem('qs_transactions', JSON.stringify(transactions)); 
                    }, [transactions, isLoaded]);
        
                    useEffect(() => { 
                        if (isLoaded) localStorage.setItem('qs_accounts', JSON.stringify(accounts)); 
                    }, [accounts, isLoaded]);
        
                    useEffect(() => { 
                        if (isLoaded) localStorage.setItem('qs_categories', JSON.stringify(categories)); 
                    }, [categories, isLoaded]);
        
                    useEffect(() => { 
                        if (isLoaded) localStorage.setItem('qs_ledgers', JSON.stringify(ledgers)); 
                    }, [ledgers, isLoaded]);
        
                    useEffect(() => { 
                        if (isLoaded) localStorage.setItem('qs_templates', JSON.stringify(templates)); 
                    }, [templates, isLoaded]);
        
                    const openConfirm = (title, content, onConfirm, type = 'confirm', confirmText = 'ç¡®å®š') => { setModalConfig({ isOpen: true, type, title, content, confirmText }); setModalCallback(() => onConfirm); };
                    const openInput = (title, initialValue, onConfirm) => { setModalInputVal(initialValue || ''); setModalConfig({ isOpen: true, type: 'input', title, content: '' }); setModalCallback(() => onConfirm); };
                    const openAlert = (title, content) => { setModalConfig({ isOpen: true, type: 'alert', title, content, confirmText: 'çŸ¥é“äº†' }); setModalCallback(() => () => {}); };
                    const closeModal = () => { setModalConfig({ ...modalConfig, isOpen: false }); setModalInputVal(''); setModalCallback(null); };
                    const handleModalConfirm = () => { if (modalCallback) { if (modalConfig.type === 'input') modalCallback(modalInputVal); else modalCallback(); } closeModal(); };
        
                    const getAccountBalance = (accountId) => {
                        const account = accounts.find(a => a.id === accountId); if (!account) return 0;
                        let balance = Number(account.initialBalance || 0);
                        const relatedTrans = transactions.filter(t => t.accountId === accountId || t.sourceId === accountId || t.targetId === accountId);
                        relatedTrans.forEach(t => {
                           if (t.type === 'expense') { if (account.group === 'asset') balance -= Number(t.amount); else balance += Number(t.amount); }
                           else if (t.type === 'income') { if (account.group === 'asset') balance += Number(t.amount); else balance -= Number(t.amount); }
                           else if (t.type === 'transfer') { if (t.sourceId === accountId) { if (account.group === 'asset') balance -= Number(t.amount); else balance += Number(t.amount); } else if (t.targetId === accountId) { if (account.group === 'asset') balance += Number(t.amount); else balance -= Number(t.amount); } }
                        });
                        return balance;
                    };
        
                    const totalAssets = useMemo(() => accounts.filter(a => a.group === 'asset').reduce((acc, a) => acc + getAccountBalance(a.id), 0), [accounts, transactions]);
                    const totalLiabilities = useMemo(() => accounts.filter(a => a.group === 'liability').reduce((acc, a) => acc + getAccountBalance(a.id), 0), [accounts, transactions]);
                    const netWorth = totalAssets - totalLiabilities;
                    const liquidBalance = useMemo(() => accounts.filter(a => a.isLiquid).reduce((acc, a) => acc + getAccountBalance(a.id), 0), [accounts, transactions]);
        
                    const handleSaveTransaction = (transData) => {
                        if (transData.type === 'expense') { const acc = accounts.find(a => a.id === transData.accountId); if (acc && acc.group === 'asset') { const currentBal = getAccountBalance(acc.id); let projectedBalance = currentBal; if (editingTransaction && editingTransaction.accountId === acc.id) projectedBalance += Number(editingTransaction.amount); if (projectedBalance < transData.amount) { openAlert("ä½™é¢ä¸è¶³", `è´¦æˆ·â€œ${acc.name}â€å½“å‰ä½™é¢ Â¥${currentBal}ï¼Œä¸è¶³ä»¥æ”¯ä»˜ Â¥${transData.amount}`); return; } } }
                        if (editingTransaction) { setTransactions(prev => prev.map(t => t.id === editingTransaction.id ? { ...transData, id: t.id, timestamp: t.timestamp } : t)); setEditingTransaction(null); } else { setTransactions([{ ...transData, id: Date.now(), timestamp: new Date().toISOString() }, ...transactions]); } setActiveTab('home');
                    };
        
                    const handleTransfer = () => {
                        const { sourceId, targetId, amount } = transferData;
                        if (!sourceId || !targetId || !amount) return; if (sourceId === targetId) return;
                        const sourceAcc = accounts.find(a => a.id === sourceId);
                        if (sourceAcc && sourceAcc.group === 'asset') { const bal = getAccountBalance(sourceId); if (bal < parseFloat(amount)) { openAlert("è½¬è´¦å¤±è´¥", `è½¬å‡ºè´¦æˆ·â€œ${sourceAcc.name}â€ä½™é¢ä¸è¶³ (å½“å‰ Â¥${bal})`); return; } }
                        const newTrans = { id: Date.now(), type: 'transfer', sourceId, targetId, amount: parseFloat(amount), date: new Date().toISOString().split('T')[0], timestamp: new Date().toISOString(), note: 'è´¦æˆ·è½¬è´¦' };
                        setTransactions([newTrans, ...transactions]); setTransferModalOpen(false); setTransferData({ sourceId: '', targetId: '', amount: '' }); openAlert("æˆåŠŸ", "è½¬è´¦å·²å®Œæˆ");
                    };
        
                    const handlePresetSelect = (preset) => setNewAccountData({ ...newAccountData, name: preset.name, type: preset.type, isLiquid: preset.isLiquid, iconKey: preset.icon, color: preset.color });
                    const handleCreateAccount = () => { if (!newAccountData.name) return; const newAcc = { id: Date.now().toString(), name: newAccountData.name, group: newAccountData.type, initialBalance: parseFloat(newAccountData.initial) || 0, iconKey: newAccountData.iconKey || (newAccountData.type === 'asset' ? 'wallet' : 'debt'), color: newAccountData.color || (newAccountData.type === 'asset' ? 'bg-stone-500' : 'bg-orange-500'), isLiquid: newAccountData.isLiquid }; setAccounts([...accounts, newAcc]); setAddAccountModalOpen(false); setNewAccountData({ name: '', type: 'asset', initial: '', isLiquid: true, iconKey: 'wallet' }); };
                    const handleAddCategory = (type) => { openInput(`æ–°å¢${type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}åˆ†ç±»`, "", (name) => { if(!name) return; const newCat = { id: Date.now().toString(), name, iconKey: 'star', color: 'bg-stone-200 text-stone-700' }; setCategories(prev => ({ ...prev, [type]: [...prev[type], newCat] })); }); };
                    const handleDeleteCategory = (type, id) => { openConfirm("åˆ é™¤åˆ†ç±»", "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ", () => { setCategories(prev => ({ ...prev, [type]: prev[type].filter(c => c.id !== id) })); }); };
                    const handleAddLedger = (ledgerData) => { const newLedger = { ...ledgerData, id: Date.now().toString() }; setLedgers([...ledgers, newLedger]); };
        
                    const accountOptions = accounts.map(a => ({ value: a.id, label: a.name, subLabel: `ä½™é¢: Â¥${getAccountBalance(a.id).toLocaleString()}` }));
                    const ledgerOptions = ledgers.map(l => ({ value: l.id, label: l.name }));
        
                    // --- ä¿®å¤äº†ç»“æ„çš„ Return éƒ¨åˆ† ---
                    return (
                        <div className="bg-stone-50 h-[100dvh] w-full fixed inset-0 font-sans selection:bg-emerald-200 max-w-md mx-auto relative shadow-2xl overflow-hidden flex flex-col text-stone-800">
                            
                            {/* iOS é¡¶éƒ¨å®‰å…¨åŒºå ä½ (æ›¿ä»£äº†åŸæ¥çš„ h-1 bg-emerald-800) */}
                            <div style={{ paddingTop: 'env(safe-area-inset-top)' }} className="w-full bg-emerald-800 flex-shrink-0 z-50"></div>
        
                            <div className="flex-1 overflow-hidden relative flex flex-col">
                                <div className="flex-1 overflow-y-auto no-scrollbar">
                                    {activeTab === 'home' && <HomeView netWorth={netWorth} liquidBalance={liquidBalance} transactions={transactions} accounts={accounts} categories={categories} setShowManageAssets={setShowManageAssets} onDeleteTransaction={(id) => openConfirm("åˆ é™¤è´¦å•", "ç¡®å®šåˆ é™¤ï¼Ÿ", () => setTransactions(t => t.filter(x => x.id !== id)))} onEditTransaction={(t) => {if(t.type === 'transfer') {openAlert("æç¤º","è½¬è´¦è¯·åˆ é™¤é‡å½•"); return;} setEditingTransaction(t); setActiveTab('add');}} />}
                                    
                                    {activeTab === 'book' && (
                                        <SpecialLedgersView 
                                            ledgers={ledgers} 
                                            categories={categories} 
                                            transactions={transactions} 
                                            onAddLedger={handleAddLedger}
                                            onDeleteLedger={(id) => openConfirm(
                                                "åˆ é™¤è´¦æœ¬", 
                                                "åˆ é™¤åï¼Œè¯¥è´¦æœ¬å†…çš„æ‰€æœ‰è®°å½•å°†åˆå¹¶è‡³â€œæ—¥å¸¸è´¦æœ¬â€ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ", 
                                                () => {
                                                    setLedgers(prev => prev.filter(l => l.id !== id));
                                                    setTransactions(prev => prev.map(t => t.ledgerId === id ? { ...t, ledgerId: 'default' } : t));
                                                }
                                            )} 
                                        />
                                    )}
        
                                    {activeTab === 'add' && (
                                                                    <AddView 
                                                                        // ...ä¿ç•™åŸæœ‰çš„ props (accounts, categories, ledgers...)
                                                                        accounts={accounts} 
                                                                        categories={categories} 
                                                                        ledgers={ledgers} 
                                                                        onSaveTransaction={handleSaveTransaction} 
                                                                        editingTransaction={editingTransaction} 
                                                                        onCancelEdit={() => {setEditingTransaction(null); setActiveTab('home');}} 
                                                                        onAddCategoryClick={handleAddCategory} 
                                                                        onDeleteCategory={handleDeleteCategory} 
                                                                        onSetCategories={setCategories} 
                                                                        ledgerOptions={ledgerOptions}
                                                                        templates={templates}
                                                                        onSaveTemplate={(tpl) => setTemplates([...templates, { ...tpl, id: Date.now().toString() }])}
                                                                        onDeleteTemplate={(id) => openConfirm("åˆ é™¤æ¨¡æ¿", "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé€Ÿè®°æ¨¡æ¿å—ï¼Ÿ", () => setTemplates(t => t.filter(x => x.id !== id)))}
                                                                        
                                                                        /* --- æ–°å¢è¿™ä¸€è¡Œ --- */
                                                                        openAlert={openAlert} 
                                                                    />
                                                                )}
									{activeTab === 'stats' && <StatsView accounts={accounts} transactions={transactions} categories={categories} />}
                                    {activeTab === 'info' && (
                                                                    <InfoView 
                                                                        openConfirm={openConfirm} 
                                                                        openAlert={openAlert} 
                                                                    />
                                                                )}
                                </div>
                                
                                {/* èµ„äº§ç®¡ç†æµ®å±‚ */}
                                {showManageAssets && <AssetManagementView onClose={() => setShowManageAssets(false)} totalNetAssets={totalAssets} totalLiabilities={totalLiabilities} netWorth={netWorth} accounts={accounts} getAccountBalance={getAccountBalance} onAddAccountClick={() => setAddAccountModalOpen(true)} onTransferClick={() => setTransferModalOpen(true)} onDeleteAccount={(id) => openConfirm("åˆ é™¤è´¦æˆ·", "ç¡®å®šåˆ é™¤ï¼Ÿ", () => setAccounts(a => a.filter(x => x.id !== id)))} onUpdateAccount={(id, field, value) => setAccounts(a => a.map(x => x.id === id ? { ...x, [field]: value } : x))} />}
                            </div>
        
                            {/* åº•éƒ¨å¯¼èˆªæ  - å…ƒæ°”å°‘å¥³ç‰ˆ */}
                    <div className="flex-shrink-0 absolute bottom-6 left-4 right-4 bg-white/80 backdrop-blur-xl p-2 rounded-full shadow-[0_8px_30px_rgba(251,113,133,0.3)] flex justify-between items-center px-6 z-40 border border-white/50 safe-area-bottom">
                        
                        <button onClick={() => { setActiveTab('home'); setEditingTransaction(null); }} 
                            className={`flex flex-col items-center gap-1 transition-all p-2 rounded-full ${activeTab === 'home' ? 'text-rose-500' : 'text-stone-300 hover:text-rose-300'}`}>
                            <Icon name="home" size={24} strokeWidth={activeTab === 'home' ? 2.5 : 2} />
                        </button>
                        
                        <button onClick={() => { setActiveTab('book'); setEditingTransaction(null); }} 
                            className={`flex flex-col items-center gap-1 transition-all p-2 rounded-full ${activeTab === 'book' ? 'text-rose-500' : 'text-stone-300 hover:text-rose-300'}`}>
                            <Icon name="book" size={24} strokeWidth={activeTab === 'book' ? 2.5 : 2} />
                        </button>
                        
                        {/* ä¸­é—´çš„å¤§æŒ‰é’®ï¼šæ”¹ä¸ºæ¸å˜ç²‰è‰² */}
                        <button onClick={() => { setActiveTab('add'); setEditingTransaction(null); }} 
                            className="bg-gradient-to-tr from-rose-400 to-pink-500 text-white w-14 h-14 rounded-full shadow-lg shadow-rose-300/50 transform -translate-y-6 hover:scale-110 active:scale-95 transition-all border-4 border-[#fff1f2] flex items-center justify-center">
                            <Icon name="plus" size={32} strokeWidth={3} />
                        </button>
                        
                        <button onClick={() => { setActiveTab('stats'); setEditingTransaction(null); }} 
                            className={`flex flex-col items-center gap-1 transition-all p-2 rounded-full ${activeTab === 'stats' ? 'text-rose-500' : 'text-stone-300 hover:text-rose-300'}`}>
                            <Icon name="pieChart" size={24} strokeWidth={activeTab === 'stats' ? 2.5 : 2} />
                        </button>
                        
                        <button onClick={() => { setActiveTab('info'); setEditingTransaction(null); }} 
                            className={`flex flex-col items-center gap-1 transition-all p-2 rounded-full ${activeTab === 'info' ? 'text-rose-500' : 'text-stone-300 hover:text-rose-300'}`}>
                            {/* è¿™é‡ŒæŠŠ info å›¾æ ‡æ¢æˆäº†çˆ±å¿ƒï¼Œæ›´é€‚åˆå¥³æœ‹å‹ */}
                            <Icon name="heart" size={24} strokeWidth={activeTab === 'info' ? 2.5 : 2} />
                        </button>
                    </div>
        
                            {/* å¼¹çª—åŒºåŸŸ */}
                            {transferModalOpen && <div className="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 animate-fade-in"><div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl"><h3 className="font-bold text-lg mb-4 text-stone-800">è´¦æˆ·è½¬è´¦</h3><div className="space-y-4"><div><label className="text-xs text-stone-400 block mb-1">è½¬å‡ºè´¦æˆ·</label><div className="relative"><CustomSelect options={accountOptions} value={transferData.sourceId} onChange={(val) => setTransferData({...transferData, sourceId: val})} placeholder="é€‰æ‹©è½¬å‡ºè´¦æˆ·" /></div></div><div><label className="text-xs text-stone-400 block mb-1">è½¬å…¥è´¦æˆ·</label><div className="relative"><CustomSelect options={accountOptions} value={transferData.targetId} onChange={(val) => setTransferData({...transferData, targetId: val})} placeholder="é€‰æ‹©è½¬å…¥è´¦æˆ·" /></div></div><div><label className="text-xs text-stone-400 block mb-1">é‡‘é¢</label><input type="number" className="w-full bg-stone-100 p-3 rounded-lg text-sm font-bold border border-stone-200" value={transferData.amount} onChange={e => setTransferData({...transferData, amount: e.target.value})}/></div><div className="flex gap-3 pt-2"><button onClick={() => setTransferModalOpen(false)} className="flex-1 bg-stone-100 py-3 rounded-xl text-stone-600 text-sm font-bold">å–æ¶ˆ</button><button onClick={handleTransfer} className="flex-1 bg-blue-500 py-3 rounded-xl text-white text-sm font-bold shadow-lg shadow-blue-200">ç¡®è®¤è½¬è´¦</button></div></div></div></div>}
                            
                            {addAccountModalOpen && <div className="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 animate-fade-in"><div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl"><h3 className="font-bold text-lg mb-4 text-stone-800">æ·»åŠ æ–°è´¦æˆ·</h3><div className="flex gap-2 overflow-x-auto no-scrollbar mb-4 pb-1">{PRESET_ACCOUNTS.map(preset => (<button key={preset.name} onClick={() => handlePresetSelect(preset)} className={`flex flex-col items-center justify-center p-2 rounded-lg min-w-[70px] border transition-all ${newAccountData.name.includes(preset.name) ? 'bg-emerald-50 border-emerald-500' : 'bg-stone-50 border-stone-200'}`}><span className="text-xs font-bold text-stone-700">{preset.name}</span></button>))}</div><div className="space-y-4"><div><label className="text-xs text-stone-400 block mb-1">è´¦æˆ·ç±»å‹</label><div className="flex bg-stone-100 p-1 rounded-lg"><button onClick={() => setNewAccountData({...newAccountData, type: 'asset'})} className={`flex-1 py-1.5 text-xs rounded-md font-bold transition-all ${newAccountData.type === 'asset' ? 'bg-white shadow text-emerald-600' : 'text-stone-500'}`}>èµ„äº§è´¦æˆ·</button><button onClick={() => setNewAccountData({...newAccountData, type: 'liability'})} className={`flex-1 py-1.5 text-xs rounded-md font-bold transition-all ${newAccountData.type === 'liability' ? 'bg-white shadow text-red-500' : 'text-stone-500'}`}>è´Ÿå€ºè´¦æˆ·</button></div></div><div><label className="text-xs text-stone-400 block mb-1">è´¦æˆ·åç§° {newAccountData.name.includes('é“¶è¡Œå¡') && "(å¯å¡«å°¾å·)"}</label><input type="text" placeholder="å¦‚: äº¤é€šé“¶è¡Œå¡" className="w-full bg-stone-100 p-2 rounded-lg text-sm" value={newAccountData.name} onChange={e => setNewAccountData({...newAccountData, name: e.target.value})} /></div>{newAccountData.type === 'asset' && (<div className="flex items-center gap-2"><input type="checkbox" id="isLiquid" checked={newAccountData.isLiquid} onChange={e => setNewAccountData({...newAccountData, isLiquid: e.target.checked})} className="w-4 h-4 rounded text-emerald-600 focus:ring-emerald-500" /><label htmlFor="isLiquid" className="text-xs text-stone-600">è®¡å…¥æµåŠ¨æ€§ä½™é¢ <span className="text-stone-400">(é“¶è¡Œå¡/å¾®ä¿¡/æ”¯ä»˜å®ç­‰éšæ—¶å¯ç”¨çš„é’±)</span></label></div>)}<div><label className="text-xs text-stone-400 block mb-1">åˆå§‹{newAccountData.type === 'asset' ? 'ä½™é¢' : 'æ¬ æ¬¾'}</label><input type="number" placeholder="0.00" className="w-full bg-stone-100 p-2 rounded-lg text-sm font-bold" value={newAccountData.initial} onChange={e => setNewAccountData({...newAccountData, initial: e.target.value})} /></div><div className="flex gap-3 pt-2"><button onClick={() => setAddAccountModalOpen(false)} className="flex-1 bg-stone-100 py-3 rounded-xl text-stone-600 text-sm font-bold">å–æ¶ˆ</button><button onClick={handleCreateAccount} className="flex-1 bg-emerald-600 py-3 rounded-xl text-white text-sm font-bold shadow-lg shadow-emerald-200">æ·»åŠ </button></div></div></div></div>}
                            
                            <Modal isOpen={modalConfig.isOpen} title={modalConfig.title} content={modalConfig.content} type={modalConfig.type} inputValue={modalInputVal} setInputValue={setModalInputVal} onConfirm={handleModalConfirm} onCancel={closeModal} confirmText={modalConfig.confirmText} />
                        </div>
                    );
                };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>